<UserControl x:Class="CopilotAgent.App.Views.McpConfigView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="clr-namespace:CopilotAgent.App.ViewModels"
             xmlns:models="clr-namespace:CopilotAgent.Core.Models;assembly=CopilotAgent.Core"
             mc:Ignorable="d"
             d:DesignHeight="600" d:DesignWidth="500"
             Background="{DynamicResource BackgroundBrush}">
    
    <UserControl.Resources>
        <BooleanToVisibilityConverter x:Key="BoolToVis"/>
        
        <!-- Status indicator colors -->
        <SolidColorBrush x:Key="StatusRunningBrush" Color="#4CAF50"/>
        <SolidColorBrush x:Key="StatusStoppedBrush" Color="#9E9E9E"/>
        <SolidColorBrush x:Key="StatusErrorBrush" Color="#F44336"/>
        <SolidColorBrush x:Key="StatusStartingBrush" Color="#FF9800"/>
    </UserControl.Resources>
    
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>
        
        <!-- Header -->
        <Border Grid.Row="0" Background="#2D2D2D" Padding="16,12">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                
                <StackPanel Grid.Column="0">
                    <TextBlock Text="MCP Servers" FontSize="18" FontWeight="SemiBold" Foreground="White"/>
                    <TextBlock Text="Manage Model Context Protocol servers" FontSize="12" Foreground="#888" Margin="0,4,0,0"/>
                </StackPanel>
                
                <StackPanel Grid.Column="1" Orientation="Horizontal" VerticalAlignment="Center">
                    <Button Content="+ Add Server" 
                            Command="{Binding AddServerCommand}"
                            Background="#0078D4" Foreground="White"
                            Padding="12,6" Margin="0,0,8,0"
                            BorderThickness="0" Cursor="Hand">
                        <Button.Style>
                            <Style TargetType="Button">
                                <Setter Property="Template">
                                    <Setter.Value>
                                        <ControlTemplate TargetType="Button">
                                            <Border Background="{TemplateBinding Background}" 
                                                    CornerRadius="4" Padding="{TemplateBinding Padding}">
                                                <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                            </Border>
                                        </ControlTemplate>
                                    </Setter.Value>
                                </Setter>
                                <Style.Triggers>
                                    <Trigger Property="IsMouseOver" Value="True">
                                        <Setter Property="Background" Value="#106EBE"/>
                                    </Trigger>
                                </Style.Triggers>
                            </Style>
                        </Button.Style>
                    </Button>
                    
                    <Button Content="âŸ³" ToolTip="Refresh"
                            Command="{Binding RefreshServersCommand}"
                            Background="Transparent" Foreground="#888"
                            FontSize="16" Padding="8,4"
                            BorderThickness="0" Cursor="Hand"/>
                </StackPanel>
            </Grid>
        </Border>
        
        <!-- Server List -->
        <Grid Grid.Row="1">
            <!-- List View -->
            <ListBox ItemsSource="{Binding Servers}"
                     SelectedItem="{Binding SelectedServer}"
                     Background="Transparent"
                     BorderThickness="0"
                     Visibility="{Binding IsEditing, Converter={StaticResource BoolToVis}, ConverterParameter=Inverse}"
                     ScrollViewer.HorizontalScrollBarVisibility="Disabled">
                <ListBox.ItemContainerStyle>
                    <Style TargetType="ListBoxItem">
                        <Setter Property="Padding" Value="0"/>
                        <Setter Property="Margin" Value="0"/>
                        <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
                        <Setter Property="Template">
                            <Setter.Value>
                                <ControlTemplate TargetType="ListBoxItem">
                                    <Border x:Name="Border" Background="Transparent" 
                                            BorderBrush="#333" BorderThickness="0,0,0,1"
                                            Padding="16,12">
                                        <ContentPresenter/>
                                    </Border>
                                    <ControlTemplate.Triggers>
                                        <Trigger Property="IsSelected" Value="True">
                                            <Setter TargetName="Border" Property="Background" Value="#1A0078D4"/>
                                        </Trigger>
                                        <Trigger Property="IsMouseOver" Value="True">
                                            <Setter TargetName="Border" Property="Background" Value="#0D0078D4"/>
                                        </Trigger>
                                    </ControlTemplate.Triggers>
                                </ControlTemplate>
                            </Setter.Value>
                        </Setter>
                    </Style>
                </ListBox.ItemContainerStyle>
                <ListBox.ItemTemplate>
                    <DataTemplate>
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            
                            <!-- Status Indicator -->
                            <Ellipse Grid.Column="0" Width="10" Height="10" 
                                     VerticalAlignment="Center" Margin="0,0,12,0">
                                <Ellipse.Style>
                                    <Style TargetType="Ellipse">
                                        <Setter Property="Fill" Value="{StaticResource StatusStoppedBrush}"/>
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding Status}" Value="Running">
                                                <Setter Property="Fill" Value="{StaticResource StatusRunningBrush}"/>
                                            </DataTrigger>
                                            <DataTrigger Binding="{Binding Status}" Value="Starting">
                                                <Setter Property="Fill" Value="{StaticResource StatusStartingBrush}"/>
                                            </DataTrigger>
                                            <DataTrigger Binding="{Binding Status}" Value="Error">
                                                <Setter Property="Fill" Value="{StaticResource StatusErrorBrush}"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </Ellipse.Style>
                            </Ellipse>
                            
                            <!-- Server Info -->
                            <StackPanel Grid.Column="1">
                                <TextBlock Text="{Binding Name}" FontWeight="Medium" FontSize="14" Foreground="White"/>
                                <TextBlock FontSize="12" Foreground="#888" Margin="0,2,0,0">
                                    <Run Text="{Binding TransportDisplay, Mode=OneWay}"/>
                                    <Run Text=" â€¢ "/>
                                    <Run Text="{Binding CommandDisplay, Mode=OneWay}"/>
                                </TextBlock>
                                <TextBlock Text="{Binding Description}" FontSize="11" Foreground="#666" 
                                           Margin="0,4,0,0" TextTrimming="CharacterEllipsis"
                                           Visibility="{Binding Description, Converter={StaticResource BoolToVis}}"/>
                            </StackPanel>
                            
                            <!-- Status Badge -->
                            <Border Grid.Column="2" CornerRadius="3" Padding="8,4" 
                                    VerticalAlignment="Center" Margin="8,0,0,0">
                                <Border.Style>
                                    <Style TargetType="Border">
                                        <Setter Property="Background" Value="#333"/>
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding Status}" Value="Running">
                                                <Setter Property="Background" Value="#1B5E20"/>
                                            </DataTrigger>
                                            <DataTrigger Binding="{Binding Status}" Value="Error">
                                                <Setter Property="Background" Value="#B71C1C"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </Border.Style>
                                <TextBlock Text="{Binding StatusDisplay}" FontSize="11" Foreground="White"/>
                            </Border>
                        </Grid>
                    </DataTemplate>
                </ListBox.ItemTemplate>
            </ListBox>
            
            <!-- Empty State -->
            <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center"
                        Visibility="{Binding Servers.Count, Converter={StaticResource BoolToVis}, ConverterParameter=Zero}">
                <TextBlock Text="No MCP servers configured" FontSize="16" Foreground="#666" HorizontalAlignment="Center"/>
                <TextBlock Text="Click 'Add Server' to configure your first MCP server" FontSize="12" Foreground="#555" 
                           HorizontalAlignment="Center" Margin="0,8,0,0"/>
            </StackPanel>
            
            <!-- Edit Panel -->
            <Border Background="#252525" Padding="20"
                    Visibility="{Binding IsEditing, Converter={StaticResource BoolToVis}}">
                <ScrollViewer VerticalScrollBarVisibility="Auto">
                    <StackPanel MaxWidth="400">
                        <TextBlock Text="Server Configuration" FontSize="16" FontWeight="SemiBold" 
                                   Foreground="White" Margin="0,0,0,20"/>
                        
                        <!-- Name -->
                        <TextBlock Text="Name *" FontSize="12" Foreground="#AAA" Margin="0,0,0,4"/>
                        <TextBox Text="{Binding EditName, UpdateSourceTrigger=PropertyChanged}"
                                 Background="#333" Foreground="White" BorderBrush="#555"
                                 Padding="8,6" FontSize="14"/>
                        
                        <!-- Description -->
                        <TextBlock Text="Description" FontSize="12" Foreground="#AAA" Margin="0,16,0,4"/>
                        <TextBox Text="{Binding EditDescription, UpdateSourceTrigger=PropertyChanged}"
                                 Background="#333" Foreground="White" BorderBrush="#555"
                                 Padding="8,6" FontSize="14"/>
                        
                        <!-- Transport -->
                        <TextBlock Text="Transport" FontSize="12" Foreground="#AAA" Margin="0,16,0,4"/>
                        <ComboBox SelectedValue="{Binding EditTransport}"
                                  SelectedValuePath="Tag"
                                  Background="#333" Foreground="White" BorderBrush="#555"
                                  Padding="8,6" FontSize="14">
                            <ComboBoxItem Content="Standard I/O (stdio)" Tag="{x:Static models:McpTransport.Stdio}"/>
                            <ComboBoxItem Content="HTTP" Tag="{x:Static models:McpTransport.Http}"/>
                        </ComboBox>
                        
                        <!-- Stdio Fields -->
                        <StackPanel Visibility="{Binding EditTransport, Converter={StaticResource BoolToVis}, ConverterParameter=Stdio}">
                            <TextBlock Text="Command *" FontSize="12" Foreground="#AAA" Margin="0,16,0,4"/>
                            <TextBox Text="{Binding EditCommand, UpdateSourceTrigger=PropertyChanged}"
                                     Background="#333" Foreground="White" BorderBrush="#555"
                                     Padding="8,6" FontSize="14" FontFamily="Consolas"/>
                            
                            <TextBlock Text="Arguments (space-separated)" FontSize="12" Foreground="#AAA" Margin="0,16,0,4"/>
                            <TextBox Text="{Binding EditArgs, UpdateSourceTrigger=PropertyChanged}"
                                     Background="#333" Foreground="White" BorderBrush="#555"
                                     Padding="8,6" FontSize="14" FontFamily="Consolas"/>
                        </StackPanel>
                        
                        <!-- HTTP Fields -->
                        <StackPanel Visibility="{Binding EditTransport, Converter={StaticResource BoolToVis}, ConverterParameter=Http}">
                            <TextBlock Text="URL *" FontSize="12" Foreground="#AAA" Margin="0,16,0,4"/>
                            <TextBox Text="{Binding EditUrl, UpdateSourceTrigger=PropertyChanged}"
                                     Background="#333" Foreground="White" BorderBrush="#555"
                                     Padding="8,6" FontSize="14"/>
                        </StackPanel>
                        
                        <!-- Timeout -->
                        <TextBlock Text="Timeout (seconds)" FontSize="12" Foreground="#AAA" Margin="0,16,0,4"/>
                        <TextBox Text="{Binding EditTimeout, UpdateSourceTrigger=PropertyChanged}"
                                 Background="#333" Foreground="White" BorderBrush="#555"
                                 Padding="8,6" FontSize="14" Width="100" HorizontalAlignment="Left"/>
                        
                        <!-- Enabled -->
                        <CheckBox Content="Enabled" IsChecked="{Binding EditEnabled}"
                                  Foreground="White" Margin="0,16,0,0"/>
                        
                        <!-- Buttons -->
                        <StackPanel Orientation="Horizontal" Margin="0,24,0,0">
                            <Button Content="Save" Command="{Binding SaveServerCommand}"
                                    Background="#0078D4" Foreground="White"
                                    Padding="16,8" Margin="0,0,8,0"
                                    BorderThickness="0" Cursor="Hand">
                                <Button.Style>
                                    <Style TargetType="Button">
                                        <Setter Property="Template">
                                            <Setter.Value>
                                                <ControlTemplate TargetType="Button">
                                                    <Border Background="{TemplateBinding Background}" 
                                                            CornerRadius="4" Padding="{TemplateBinding Padding}">
                                                        <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                                    </Border>
                                                </ControlTemplate>
                                            </Setter.Value>
                                        </Setter>
                                    </Style>
                                </Button.Style>
                            </Button>
                            <Button Content="Cancel" Command="{Binding CancelEditCommand}"
                                    Background="#555" Foreground="White"
                                    Padding="16,8"
                                    BorderThickness="0" Cursor="Hand">
                                <Button.Style>
                                    <Style TargetType="Button">
                                        <Setter Property="Template">
                                            <Setter.Value>
                                                <ControlTemplate TargetType="Button">
                                                    <Border Background="{TemplateBinding Background}" 
                                                            CornerRadius="4" Padding="{TemplateBinding Padding}">
                                                        <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                                    </Border>
                                                </ControlTemplate>
                                            </Setter.Value>
                                        </Setter>
                                    </Style>
                                </Button.Style>
                            </Button>
                        </StackPanel>
                    </StackPanel>
                </ScrollViewer>
            </Border>
        </Grid>
        
        <!-- Action Bar (when server selected) -->
        <Border Grid.Row="2" Background="#2D2D2D" Padding="12,8"
                Visibility="{Binding SelectedServer, Converter={StaticResource BoolToVis}}">
            <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                <Button Content="â–¶ Start" Command="{Binding StartServerCommand}"
                        IsEnabled="{Binding SelectedServer.IsStopped}"
                        Background="#4CAF50" Foreground="White"
                        Padding="12,6" Margin="0,0,8,0"
                        BorderThickness="0" Cursor="Hand">
                    <Button.Style>
                        <Style TargetType="Button">
                            <Setter Property="Template">
                                <Setter.Value>
                                    <ControlTemplate TargetType="Button">
                                        <Border Background="{TemplateBinding Background}" 
                                                CornerRadius="4" Padding="{TemplateBinding Padding}"
                                                Opacity="{TemplateBinding Opacity}">
                                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                        </Border>
                                    </ControlTemplate>
                                </Setter.Value>
                            </Setter>
                            <Style.Triggers>
                                <Trigger Property="IsEnabled" Value="False">
                                    <Setter Property="Opacity" Value="0.5"/>
                                </Trigger>
                            </Style.Triggers>
                        </Style>
                    </Button.Style>
                </Button>
                
                <Button Content="â¹ Stop" Command="{Binding StopServerCommand}"
                        IsEnabled="{Binding SelectedServer.IsRunning}"
                        Background="#F44336" Foreground="White"
                        Padding="12,6" Margin="0,0,8,0"
                        BorderThickness="0" Cursor="Hand">
                    <Button.Style>
                        <Style TargetType="Button">
                            <Setter Property="Template">
                                <Setter.Value>
                                    <ControlTemplate TargetType="Button">
                                        <Border Background="{TemplateBinding Background}" 
                                                CornerRadius="4" Padding="{TemplateBinding Padding}">
                                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                        </Border>
                                    </ControlTemplate>
                                </Setter.Value>
                            </Setter>
                            <Style.Triggers>
                                <Trigger Property="IsEnabled" Value="False">
                                    <Setter Property="Opacity" Value="0.5"/>
                                </Trigger>
                            </Style.Triggers>
                        </Style>
                    </Button.Style>
                </Button>
                
                <Button Content="âœ Edit" Command="{Binding EditServerCommand}"
                        Background="#555" Foreground="White"
                        Padding="12,6" Margin="0,0,8,0"
                        BorderThickness="0" Cursor="Hand">
                    <Button.Style>
                        <Style TargetType="Button">
                            <Setter Property="Template">
                                <Setter.Value>
                                    <ControlTemplate TargetType="Button">
                                        <Border Background="{TemplateBinding Background}" 
                                                CornerRadius="4" Padding="{TemplateBinding Padding}">
                                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                        </Border>
                                    </ControlTemplate>
                                </Setter.Value>
                            </Setter>
                        </Style>
                    </Button.Style>
                </Button>
                
                <Button Content="ðŸ—‘ Delete" Command="{Binding DeleteServerCommand}"
                        Background="#B71C1C" Foreground="White"
                        Padding="12,6"
                        BorderThickness="0" Cursor="Hand">
                    <Button.Style>
                        <Style TargetType="Button">
                            <Setter Property="Template">
                                <Setter.Value>
                                    <ControlTemplate TargetType="Button">
                                        <Border Background="{TemplateBinding Background}" 
                                                CornerRadius="4" Padding="{TemplateBinding Padding}">
                                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                        </Border>
                                    </ControlTemplate>
                                </Setter.Value>
                            </Setter>
                        </Style>
                    </Button.Style>
                </Button>
            </StackPanel>
        </Border>
    </Grid>
</UserControl>