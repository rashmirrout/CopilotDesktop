<UserControl x:Class="CopilotAgent.App.Views.PanelView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:converters="clr-namespace:CopilotAgent.App.Converters"
             xmlns:mdxaml="clr-namespace:MdXaml;assembly=MdXaml"
             xmlns:emoji="clr-namespace:Emoji.Wpf;assembly=Emoji.Wpf"
             mc:Ignorable="d"
             d:DesignHeight="700" d:DesignWidth="1100"
             Background="White">

    <UserControl.Resources>
        <converters:BoolToVisibilityConverter x:Key="BoolToVis"/>
        <converters:InverseBoolToVisibilityConverter x:Key="InverseBoolToVis"/>
        <converters:StringToVisibilityConverter x:Key="StringToVis"/>
        <converters:StringToBrushConverter x:Key="StringToBrush"/>

        <!-- Side panel slide animations -->
        <Storyboard x:Key="SlideInStoryboard">
            <DoubleAnimation Storyboard.TargetName="SidePanel"
                             Storyboard.TargetProperty="(UIElement.RenderTransform).(TranslateTransform.X)"
                             From="550" To="0" Duration="0:0:0.3">
                <DoubleAnimation.EasingFunction>
                    <QuarticEase EasingMode="EaseOut"/>
                </DoubleAnimation.EasingFunction>
            </DoubleAnimation>
            <DoubleAnimation Storyboard.TargetName="Backdrop"
                             Storyboard.TargetProperty="Opacity"
                             From="0" To="1" Duration="0:0:0.25"/>
        </Storyboard>

        <Storyboard x:Key="SlideOutStoryboard">
            <DoubleAnimation Storyboard.TargetName="SidePanel"
                             Storyboard.TargetProperty="(UIElement.RenderTransform).(TranslateTransform.X)"
                             From="0" To="550" Duration="0:0:0.25">
                <DoubleAnimation.EasingFunction>
                    <QuarticEase EasingMode="EaseIn"/>
                </DoubleAnimation.EasingFunction>
            </DoubleAnimation>
            <DoubleAnimation Storyboard.TargetName="Backdrop"
                             Storyboard.TargetProperty="Opacity"
                             From="1" To="0" Duration="0:0:0.2"/>
        </Storyboard>

        <!-- MdXaml Markdown style -->
        <Style x:Key="MdXamlStyle" TargetType="mdxaml:MarkdownScrollViewer">
            <Setter Property="MarkdownStyleName" Value="Standard"/>
            <Setter Property="Foreground" Value="#424242"/>
            <Setter Property="FontSize" Value="13"/>
            <Setter Property="VerticalScrollBarVisibility" Value="Disabled"/>
            <Setter Property="Background" Value="Transparent"/>
        </Style>

        <!-- Phase badge style -->
        <Style x:Key="PhaseBadge" TargetType="Border">
            <Setter Property="CornerRadius" Value="10"/>
            <Setter Property="Padding" Value="10,4"/>
            <Setter Property="HorizontalAlignment" Value="Left"/>
        </Style>

        <!-- Action button style -->
        <Style x:Key="ActionButton" TargetType="Button">
            <Setter Property="Padding" Value="16,8"/>
            <Setter Property="FontSize" Value="13"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="ActionBorder"
                                Background="{TemplateBinding Background}"
                                CornerRadius="4"
                                Padding="{TemplateBinding Padding}">
                            <ContentPresenter HorizontalAlignment="Center"
                                              VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter TargetName="ActionBorder" Property="Opacity" Value="0.4"/>
                            </Trigger>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="ActionBorder" Property="Opacity" Value="0.85"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
            <Style.Triggers>
                <Trigger Property="IsEnabled" Value="False">
                    <Setter Property="Cursor" Value="Arrow"/>
                </Trigger>
            </Style.Triggers>
        </Style>

        <!-- Small icon button -->
        <Style x:Key="IconButton" TargetType="Button">
            <Setter Property="Padding" Value="6,4"/>
            <Setter Property="FontSize" Value="15"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border Background="{TemplateBinding Background}"
                                CornerRadius="4"
                                Padding="{TemplateBinding Padding}">
                            <ContentPresenter HorizontalAlignment="Center"
                                              VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter Property="Background" Value="#E0E0E0"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- Settings label style -->
        <Style x:Key="SettingsLabel" TargetType="TextBlock">
            <Setter Property="FontSize" Value="12"/>
            <Setter Property="Foreground" Value="#616161"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
            <Setter Property="Margin" Value="0,0,6,0"/>
        </Style>

        <!-- Side panel section header -->
        <Style x:Key="SidePanelSectionHeader" TargetType="TextBlock">
            <Setter Property="FontSize" Value="13"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Foreground" Value="#424242"/>
            <Setter Property="Margin" Value="0,0,0,10"/>
        </Style>
    </UserControl.Resources>

    <Grid>
        <!-- Main content grid -->
        <Grid>
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>  <!-- Header -->
                <RowDefinition Height="Auto"/>  <!-- Execution indicator -->
                <RowDefinition Height="*"/>     <!-- Three-pane content -->
                <RowDefinition Height="Auto"/>  <!-- Bottom input bar -->
            </Grid.RowDefinitions>

            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <!-- Row 0: Header Bar                                       -->
            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <Border Grid.Row="0" Background="#F5F5F5" Padding="16,10"
                    BorderBrush="#E0E0E0" BorderThickness="0,0,0,1">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto"/>  <!-- Title -->
                        <ColumnDefinition Width="Auto"/>  <!-- Phase badge -->
                        <ColumnDefinition Width="*"/>     <!-- Status center -->
                        <ColumnDefinition Width="Auto"/>  <!-- Convergence -->
                        <ColumnDefinition Width="Auto"/>  <!-- Turns -->
                        <ColumnDefinition Width="Auto"/>  <!-- Cost -->
                        <ColumnDefinition Width="Auto"/>  <!-- Action buttons -->
                        <ColumnDefinition Width="Auto"/>  <!-- Settings -->
                    </Grid.ColumnDefinitions>

                    <!-- Title -->
                    <emoji:TextBlock Grid.Column="0" Text="ðŸŽ™ Panel Discussion"
                               FontSize="16" FontWeight="SemiBold"
                               VerticalAlignment="Center" Foreground="#212121"/>

                    <!-- Phase Badge -->
                    <Border Grid.Column="1" Style="{StaticResource PhaseBadge}"
                            Margin="12,0,0,0" VerticalAlignment="Center"
                            Opacity="{Binding CurrentPhaseBadgeOpacity}"
                            Background="{Binding CurrentPhaseColor, Converter={StaticResource StringToBrush}}">
                        <TextBlock Text="{Binding CurrentPhaseDisplay}"
                                   FontSize="12" FontWeight="SemiBold" Foreground="White"/>
                    </Border>

                    <!-- Status Display (center) -->
                    <StackPanel Grid.Column="2" Orientation="Horizontal"
                                HorizontalAlignment="Center" VerticalAlignment="Center">
                        <emoji:TextBlock Text="{Binding StatusIcon}" FontSize="16"
                                   VerticalAlignment="Center" Margin="0,0,6,0"/>
                        <TextBlock Text="{Binding StatusText}" FontSize="12"
                                   FontWeight="SemiBold" VerticalAlignment="Center"
                                   Foreground="#616161"/>
                    </StackPanel>

                    <!-- Convergence Indicator -->
                    <Border Grid.Column="3" CornerRadius="10" Padding="8,4"
                            Margin="4,0" VerticalAlignment="Center"
                            Background="#E0F2F1" BorderBrush="#80CBC4" BorderThickness="1">
                        <StackPanel Orientation="Horizontal">
                            <emoji:TextBlock Text="ðŸŽ¯" FontSize="11" VerticalAlignment="Center" Margin="0,0,4,0"/>
                            <TextBlock Text="{Binding ConvergenceDisplay}" FontSize="11"
                                       FontWeight="SemiBold" Foreground="#00695C"
                                       VerticalAlignment="Center"/>
                        </StackPanel>
                    </Border>

                    <!-- Turns Display -->
                    <Border Grid.Column="4" CornerRadius="10" Padding="8,4"
                            Margin="4,0" VerticalAlignment="Center"
                            Background="#E3F2FD" BorderBrush="#90CAF9" BorderThickness="1">
                        <StackPanel Orientation="Horizontal">
                            <emoji:TextBlock Text="ðŸ”„" FontSize="11" VerticalAlignment="Center" Margin="0,0,4,0"/>
                            <TextBlock Text="{Binding TurnsDisplay}" FontSize="11"
                                       FontWeight="SemiBold" Foreground="#1565C0"
                                       VerticalAlignment="Center"/>
                        </StackPanel>
                    </Border>

                    <!-- Cost Display -->
                    <Border Grid.Column="5" CornerRadius="10" Padding="8,4"
                            Margin="4,0" VerticalAlignment="Center"
                            Background="#FFF3E0" BorderBrush="#FFE0B2" BorderThickness="1">
                        <StackPanel Orientation="Horizontal">
                            <emoji:TextBlock Text="ðŸ’°" FontSize="11" VerticalAlignment="Center" Margin="0,0,4,0"/>
                            <TextBlock Text="{Binding CostDisplay}" FontSize="11"
                                       FontWeight="SemiBold" Foreground="#E65100"
                                       VerticalAlignment="Center"/>
                        </StackPanel>
                    </Border>

                    <!-- Action Buttons -->
                    <StackPanel Grid.Column="6" Orientation="Horizontal" Margin="8,0,0,0">
                        <!-- Pause -->
                        <Button Style="{StaticResource ActionButton}"
                                Background="#FF9800" Foreground="White"
                                Padding="10,6" Margin="0,0,4,0"
                                Command="{Binding PauseDiscussionCommand}"
                                ToolTip="Pause discussion">
                            <emoji:TextBlock Text="â¸" FontSize="13"/>
                        </Button>
                        <!-- Resume -->
                        <Button Style="{StaticResource ActionButton}"
                                Background="#4CAF50" Foreground="White"
                                Padding="10,6" Margin="0,0,4,0"
                                Command="{Binding ResumeDiscussionCommand}"
                                ToolTip="Resume discussion">
                            <emoji:TextBlock Text="â–¶" FontSize="13"/>
                        </Button>
                        <!-- Stop -->
                        <Button Style="{StaticResource ActionButton}"
                                Background="#F44336" Foreground="White"
                                Padding="10,6" Margin="0,0,4,0"
                                Command="{Binding StopDiscussionCommand}"
                                ToolTip="Stop discussion">
                            <emoji:TextBlock Text="â¹" FontSize="13"/>
                        </Button>
                        <!-- Reset -->
                        <Button Style="{StaticResource ActionButton}"
                                Background="#EEEEEE" Foreground="#424242"
                                Padding="10,6"
                                Command="{Binding ResetPanelCommand}"
                                ToolTip="Reset panel">
                            <emoji:TextBlock Text="ðŸ”„ Reset"/>
                        </Button>
                    </StackPanel>

                    <!-- Settings gear with pending badge -->
                    <Grid Grid.Column="7" Margin="4,0">
                        <Button ToolTip="Settings &amp; Event Log"
                                Style="{StaticResource IconButton}"
                                Command="{Binding ToggleSidePanelCommand}">
                            <emoji:TextBlock Text="âš™" FontSize="15"/>
                        </Button>
                        <Border CornerRadius="7" Width="14" Height="14"
                                Background="#F44336"
                                HorizontalAlignment="Right" VerticalAlignment="Top"
                                Margin="0,-2,-2,0"
                                Visibility="{Binding HasPendingChanges, Converter={StaticResource BoolToVis}}">
                            <TextBlock Text="{Binding PendingChangesCount}"
                                       FontSize="8" FontWeight="Bold" Foreground="White"
                                       HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                    </Grid>
                </Grid>
            </Border>

            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <!-- Row 1: Execution Status Indicator (pulsing strip)       -->
            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <Border Grid.Row="1" Background="#E8F5E9" Padding="12,8" Margin="16,8,16,0"
                    CornerRadius="6"
                    Opacity="{Binding ExecutionPulseOpacity}"
                    Visibility="{Binding IsExecutionIndicatorVisible, Converter={StaticResource BoolToVis}}">
                <StackPanel Orientation="Horizontal">
                    <Ellipse Width="10" Height="10" Fill="#2E7D32" Margin="0,0,8,0"
                             VerticalAlignment="Center"/>
                    <TextBlock Text="{Binding ExecutionStatusText}" FontSize="13"
                               FontWeight="SemiBold" Foreground="#1B5E20"
                               VerticalAlignment="Center"/>
                </StackPanel>
            </Border>

            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <!-- Row 2: Three-Pane Content Area                          -->
            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <Grid Grid.Row="2" Margin="8,8,8,0">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="280" MinWidth="200"/>  <!-- Left: Head Chat -->
                    <ColumnDefinition Width="Auto"/>                <!-- Splitter -->
                    <ColumnDefinition Width="*" MinWidth="300"/>    <!-- Center: Discussion -->
                    <ColumnDefinition Width="Auto"/>                <!-- Splitter -->
                    <ColumnDefinition Width="240" MinWidth="180"/>  <!-- Right: Inspector -->
                </Grid.ColumnDefinitions>

                <!-- â•â•â• LEFT PANE: User â†” Head Conversation â•â•â• -->
                <Border Grid.Column="0" Background="#FAFAFA"
                        BorderBrush="#E0E0E0" BorderThickness="1"
                        CornerRadius="6" Margin="0,0,4,0">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>  <!-- Pane header -->
                            <RowDefinition Height="*"/>     <!-- Chat messages -->
                            <RowDefinition Height="Auto"/>  <!-- Approval banner -->
                        </Grid.RowDefinitions>

                        <!-- Pane Header -->
                        <Border Grid.Row="0" Background="#E3F2FD" Padding="10,8"
                                CornerRadius="6,6,0,0"
                                BorderBrush="#90CAF9" BorderThickness="0,0,0,1">
                            <StackPanel Orientation="Horizontal">
                                <emoji:TextBlock Text="ðŸŽ“" FontSize="14" VerticalAlignment="Center" Margin="0,0,6,0"/>
                                <TextBlock Text="Head Agent" FontSize="13" FontWeight="SemiBold"
                                           Foreground="#1565C0" VerticalAlignment="Center"/>
                            </StackPanel>
                        </Border>

                        <!-- Chat Messages -->
                        <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto"
                                      x:Name="HeadChatScroller"
                                      Padding="6">
                            <ItemsControl ItemsSource="{Binding HeadChatMessages}">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Border Margin="4,4,4,4" Padding="10,8"
                                                CornerRadius="8">
                                            <Border.Style>
                                                <Style TargetType="Border">
                                                    <Setter Property="Background" Value="#E3F2FD"/>
                                                    <Setter Property="HorizontalAlignment" Value="Left"/>
                                                    <Setter Property="MaxWidth" Value="240"/>
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding IsUser}" Value="True">
                                                            <Setter Property="Background" Value="#E8EAF6"/>
                                                            <Setter Property="HorizontalAlignment" Value="Right"/>
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </Border.Style>
                                            <StackPanel>
                                                <TextBlock Text="{Binding Author}" FontSize="11"
                                                           FontWeight="SemiBold" Margin="0,0,0,3">
                                                    <TextBlock.Style>
                                                        <Style TargetType="TextBlock">
                                                            <Setter Property="Foreground" Value="#1565C0"/>
                                                            <Style.Triggers>
                                                                <DataTrigger Binding="{Binding IsUser}" Value="True">
                                                                    <Setter Property="Foreground" Value="#3F51B5"/>
                                                                </DataTrigger>
                                                            </Style.Triggers>
                                                        </Style>
                                                    </TextBlock.Style>
                                                </TextBlock>
                                                <mdxaml:MarkdownScrollViewer
                                                    Markdown="{Binding Content}"
                                                    Style="{StaticResource MdXamlStyle}"
                                                    FontSize="12"/>
                                            </StackPanel>
                                        </Border>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </ScrollViewer>

                        <!-- Approval Banner -->
                        <Border Grid.Row="2" Background="#FFF8E1" Padding="10,8"
                                CornerRadius="0,0,6,6"
                                BorderBrush="#FFE082" BorderThickness="0,1,0,0"
                                Visibility="{Binding IsAwaitingApproval, Converter={StaticResource BoolToVis}}">
                            <StackPanel>
                                <emoji:TextBlock Text="ðŸ“‹ Review the panel plan above"
                                           FontSize="12" FontWeight="SemiBold"
                                           Foreground="#F57F17" Margin="0,0,0,6"/>
                                <Button Style="{StaticResource ActionButton}"
                                        Background="#4CAF50" Foreground="White"
                                        HorizontalAlignment="Stretch"
                                        Command="{Binding ApproveAndStartPanelCommand}">
                                    <emoji:TextBlock Text="âœ… Approve &amp; Start Panel"/>
                                </Button>
                            </StackPanel>
                        </Border>
                    </Grid>
                </Border>

                <!-- Splitter 1 -->
                <GridSplitter Grid.Column="1" Width="4" Background="Transparent"
                              HorizontalAlignment="Center" VerticalAlignment="Stretch"
                              Cursor="SizeWE"/>

                <!-- â•â•â• CENTER PANE: Panel Discussion Stream â•â•â• -->
                <Border Grid.Column="2" Background="White"
                        BorderBrush="#E0E0E0" BorderThickness="1"
                        CornerRadius="6" Margin="4,0,4,0">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>  <!-- Pane header -->
                            <RowDefinition Height="*"/>     <!-- Discussion stream -->
                        </Grid.RowDefinitions>

                        <!-- Pane Header -->
                        <Border Grid.Row="0" Background="#E8F5E9" Padding="10,8"
                                CornerRadius="6,6,0,0"
                                BorderBrush="#A5D6A7" BorderThickness="0,0,0,1">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>
                                <StackPanel Grid.Column="0" Orientation="Horizontal">
                                    <emoji:TextBlock Text="ðŸ—£" FontSize="14" VerticalAlignment="Center" Margin="0,0,6,0"/>
                                    <TextBlock Text="Discussion Stream" FontSize="13" FontWeight="SemiBold"
                                               Foreground="#2E7D32" VerticalAlignment="Center"/>
                                    <Border CornerRadius="8" Padding="6,2" Margin="8,0,0,0"
                                            Background="#C8E6C9" VerticalAlignment="Center">
                                        <TextBlock FontSize="10" FontWeight="SemiBold" Foreground="#1B5E20">
                                            <Run Text="{Binding DiscussionMessages.Count, Mode=OneWay}"/>
                                            <Run Text=" msgs"/>
                                        </TextBlock>
                                    </Border>
                                </StackPanel>
                                <!-- Agent pill indicators -->
                                <ItemsControl Grid.Column="1" ItemsSource="{Binding PanelAgents}">
                                    <ItemsControl.ItemsPanel>
                                        <ItemsPanelTemplate>
                                            <StackPanel Orientation="Horizontal"/>
                                        </ItemsPanelTemplate>
                                    </ItemsControl.ItemsPanel>
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <Border CornerRadius="10" Padding="6,2" Margin="2,0"
                                                    ToolTip="{Binding Name}"
                                                    BorderThickness="1"
                                                    BorderBrush="{Binding StatusColor, Converter={StaticResource StringToBrush}}"
                                                    Background="#FAFAFA" Cursor="Hand"
                                                    MouseDown="AgentPill_MouseDown">
                                                <StackPanel Orientation="Horizontal">
                                                    <Ellipse Width="6" Height="6" Margin="0,0,4,0"
                                                             VerticalAlignment="Center"
                                                             Fill="{Binding StatusColor, Converter={StaticResource StringToBrush}}"/>
                                                    <TextBlock Text="{Binding RoleIcon}" FontSize="10"
                                                               VerticalAlignment="Center"/>
                                                </StackPanel>
                                            </Border>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                            </Grid>
                        </Border>

                        <!-- Discussion Messages -->
                        <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto"
                                      x:Name="DiscussionScroller"
                                      Padding="8"
                                      PreviewMouseWheel="DiscussionScroller_PreviewMouseWheel">
                            <ItemsControl ItemsSource="{Binding DiscussionMessages}">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Border Margin="2,3" Padding="10,8" CornerRadius="6">
                                            <Border.Style>
                                                <Style TargetType="Border">
                                                    <Setter Property="Background" Value="#FAFAFA"/>
                                                    <Setter Property="BorderBrush" Value="#E0E0E0"/>
                                                    <Setter Property="BorderThickness" Value="0,0,0,1"/>
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding IsCommentary}" Value="True">
                                                            <Setter Property="Background" Value="#F3E5F5"/>
                                                            <Setter Property="BorderBrush" Value="#CE93D8"/>
                                                            <Setter Property="BorderThickness" Value="3,0,0,0"/>
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </Border.Style>
                                            <Grid>
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="Auto"/>  <!-- Role icon -->
                                                    <ColumnDefinition Width="*"/>     <!-- Content -->
                                                    <ColumnDefinition Width="Auto"/>  <!-- Timestamp -->
                                                </Grid.ColumnDefinitions>

                                                <!-- Role icon + color bar -->
                                                <Border Grid.Column="0" Width="28" Height="28"
                                                        CornerRadius="14" Margin="0,0,8,0"
                                                        VerticalAlignment="Top"
                                                        Background="{Binding RoleColor, Converter={StaticResource StringToBrush}}">
                                                    <emoji:TextBlock Text="{Binding RoleIcon}" FontSize="13"
                                                               HorizontalAlignment="Center"
                                                               VerticalAlignment="Center"/>
                                                </Border>

                                                <!-- Author + content -->
                                                <StackPanel Grid.Column="1">
                                                    <StackPanel Orientation="Horizontal" Margin="0,0,0,3">
                                                        <TextBlock Text="{Binding AuthorName}" FontSize="12"
                                                                   FontWeight="SemiBold"
                                                                   Foreground="{Binding RoleColor, Converter={StaticResource StringToBrush}}"/>
                                                        <TextBlock Text="{Binding Role}" FontSize="10"
                                                                   Foreground="#9E9E9E" Margin="6,0,0,0"
                                                                   VerticalAlignment="Center"/>
                                                    </StackPanel>
                                                    <mdxaml:MarkdownScrollViewer
                                                        Markdown="{Binding Content}"
                                                        Style="{StaticResource MdXamlStyle}"
                                                        FontSize="12.5"/>
                                                </StackPanel>

                                                <!-- Timestamp -->
                                                <TextBlock Grid.Column="2" FontSize="9"
                                                           Foreground="#BDBDBD" VerticalAlignment="Top"
                                                           Margin="6,2,0,0"
                                                           Text="{Binding Timestamp, StringFormat='{}{0:HH:mm:ss}'}"/>
                                            </Grid>
                                        </Border>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </ScrollViewer>
                    </Grid>
                </Border>

                <!-- Splitter 2 -->
                <GridSplitter Grid.Column="3" Width="4" Background="Transparent"
                              HorizontalAlignment="Center" VerticalAlignment="Stretch"
                              Cursor="SizeWE"/>

                <!-- â•â•â• RIGHT PANE: Agent Inspector â•â•â• -->
                <Border Grid.Column="4" Background="#FAFAFA"
                        BorderBrush="#E0E0E0" BorderThickness="1"
                        CornerRadius="6" Margin="4,0,0,0">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>  <!-- Pane header -->
                            <RowDefinition Height="Auto"/>  <!-- Agent list -->
                            <RowDefinition Height="*"/>     <!-- Selected agent detail -->
                        </Grid.RowDefinitions>

                        <!-- Pane Header -->
                        <Border Grid.Row="0" Background="#FFF3E0" Padding="10,8"
                                CornerRadius="6,6,0,0"
                                BorderBrush="#FFE0B2" BorderThickness="0,0,0,1">
                            <StackPanel Orientation="Horizontal">
                                <emoji:TextBlock Text="ðŸ”" FontSize="14" VerticalAlignment="Center" Margin="0,0,6,0"/>
                                <TextBlock Text="Agent Inspector" FontSize="13" FontWeight="SemiBold"
                                           Foreground="#E65100" VerticalAlignment="Center"/>
                            </StackPanel>
                        </Border>

                        <!-- Agent List (clickable pills) -->
                        <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto"
                                      MaxHeight="200" Padding="6,4">
                            <ItemsControl ItemsSource="{Binding PanelAgents}">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Border Margin="2,2" Padding="8,6" CornerRadius="6"
                                                Cursor="Hand"
                                                BorderThickness="1"
                                                BorderBrush="{Binding StatusColor, Converter={StaticResource StringToBrush}}"
                                                Background="White"
                                                MouseDown="AgentCard_MouseDown">
                                            <Grid>
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="Auto"/>
                                                    <ColumnDefinition Width="*"/>
                                                    <ColumnDefinition Width="Auto"/>
                                                </Grid.ColumnDefinitions>

                                                <!-- Role icon -->
                                                <emoji:TextBlock Grid.Column="0" Text="{Binding RoleIcon}"
                                                           FontSize="16" VerticalAlignment="Center"
                                                           Margin="0,0,6,0"/>

                                                <!-- Name + Role -->
                                                <StackPanel Grid.Column="1" VerticalAlignment="Center">
                                                    <TextBlock Text="{Binding Name}" FontSize="11"
                                                               FontWeight="SemiBold" Foreground="#212121"
                                                               TextTrimming="CharacterEllipsis"/>
                                                    <TextBlock FontSize="9" Foreground="#9E9E9E">
                                                        <Run Text="{Binding Role, Mode=OneWay}"/>
                                                        <Run Text=" Â· "/>
                                                        <Run Text="{Binding MessageCount, Mode=OneWay}"/>
                                                        <Run Text=" msgs"/>
                                                    </TextBlock>
                                                </StackPanel>

                                                <!-- Status dot -->
                                                <Ellipse Grid.Column="2" Width="8" Height="8"
                                                         VerticalAlignment="Center"
                                                         Fill="{Binding StatusColor, Converter={StaticResource StringToBrush}}"
                                                         ToolTip="{Binding Status}"/>
                                            </Grid>
                                        </Border>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </ScrollViewer>

                        <!-- Selected Agent Details -->
                        <Border Grid.Row="2" Margin="6,4,6,6">
                            <!-- No agent selected placeholder -->
                            <Grid>
                                <!-- Placeholder when no agent selected -->
                                <TextBlock Text="Select an agent to view details"
                                           FontSize="11" Foreground="#BDBDBD"
                                           FontStyle="Italic"
                                           HorizontalAlignment="Center"
                                           VerticalAlignment="Center"
                                           Visibility="{Binding SelectedAgent, Converter={StaticResource InverseBoolToVis}}"/>

                                <!-- Agent detail panel -->
                                <ScrollViewer VerticalScrollBarVisibility="Auto"
                                              Visibility="{Binding SelectedAgent, Converter={StaticResource BoolToVis}}">
                                    <StackPanel DataContext="{Binding SelectedAgent}">
                                        <!-- Agent header -->
                                        <Border Background="White" CornerRadius="6" Padding="10,8"
                                                Margin="0,0,0,6"
                                                BorderBrush="#E0E0E0" BorderThickness="1">
                                            <StackPanel>
                                                <StackPanel Orientation="Horizontal" Margin="0,0,0,4">
                                                    <emoji:TextBlock Text="{Binding RoleIcon}" FontSize="18"
                                                               VerticalAlignment="Center" Margin="0,0,6,0"/>
                                                    <TextBlock Text="{Binding Name}" FontSize="14"
                                                               FontWeight="SemiBold" Foreground="#212121"
                                                               VerticalAlignment="Center"/>
                                                </StackPanel>
                                                <StackPanel Orientation="Horizontal">
                                                    <Border CornerRadius="8" Padding="6,2" Margin="0,0,6,0"
                                                            Background="{Binding StatusColor, Converter={StaticResource StringToBrush}}">
                                                        <TextBlock Text="{Binding Status}" FontSize="10"
                                                                   Foreground="White" FontWeight="SemiBold"/>
                                                    </Border>
                                                    <TextBlock Text="{Binding Role}" FontSize="11"
                                                               Foreground="#757575" VerticalAlignment="Center"/>
                                                </StackPanel>
                                            </StackPanel>
                                        </Border>

                                        <!-- Stats -->
                                        <Border Background="White" CornerRadius="6" Padding="10,8"
                                                Margin="0,0,0,6"
                                                BorderBrush="#E0E0E0" BorderThickness="1">
                                            <Grid>
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="*"/>
                                                    <ColumnDefinition Width="*"/>
                                                </Grid.ColumnDefinitions>
                                                <Grid.RowDefinitions>
                                                    <RowDefinition Height="Auto"/>
                                                    <RowDefinition Height="Auto"/>
                                                </Grid.RowDefinitions>

                                                <StackPanel Grid.Row="0" Grid.Column="0" Margin="0,0,0,4">
                                                    <TextBlock Text="Messages" FontSize="9" Foreground="#9E9E9E"/>
                                                    <TextBlock Text="{Binding MessageCount}" FontSize="16"
                                                               FontWeight="Bold" Foreground="#1565C0"/>
                                                </StackPanel>

                                                <StackPanel Grid.Row="0" Grid.Column="1" Margin="0,0,0,4">
                                                    <TextBlock Text="Tool Calls" FontSize="9" Foreground="#9E9E9E"/>
                                                    <TextBlock Text="{Binding ToolCallCount}" FontSize="16"
                                                               FontWeight="Bold" Foreground="#7B1FA2"/>
                                                </StackPanel>

                                                <StackPanel Grid.Row="1" Grid.Column="0" Grid.ColumnSpan="2">
                                                    <TextBlock Text="Last Tool" FontSize="9" Foreground="#9E9E9E"/>
                                                    <TextBlock Text="{Binding LastToolCall}" FontSize="11"
                                                               Foreground="#616161" TextTrimming="CharacterEllipsis"/>
                                                </StackPanel>
                                            </Grid>
                                        </Border>

                                        <!-- Last Message -->
                                        <Border Background="White" CornerRadius="6" Padding="10,8"
                                                BorderBrush="#E0E0E0" BorderThickness="1">
                                            <StackPanel>
                                                <TextBlock Text="Last Message" FontSize="9"
                                                           Foreground="#9E9E9E" Margin="0,0,0,3"/>
                                                <TextBlock Text="{Binding LastMessage}" FontSize="11"
                                                           Foreground="#424242" TextWrapping="Wrap"
                                                           MaxHeight="120"/>
                                            </StackPanel>
                                        </Border>
                                    </StackPanel>
                                </ScrollViewer>
                            </Grid>
                        </Border>
                    </Grid>
                </Border>
            </Grid>

            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <!-- Row 3: Bottom Input Bar                                 -->
            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <Border Grid.Row="3" Background="#F5F5F5" Padding="16,10"
                    BorderBrush="#E0E0E0" BorderThickness="0,1,0,0">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>

                    <!-- Primary input (start / send / follow-up) -->
                    <Grid Grid.Column="0">
                        <TextBox x:Name="MainInput"
                                 Text="{Binding UserInput, UpdateSourceTrigger=PropertyChanged}"
                                 Padding="10,8" FontSize="13"
                                 BorderBrush="#BDBDBD" BorderThickness="1"
                                 AcceptsReturn="True"
                                 TextWrapping="Wrap"
                                 MaxHeight="100"
                                 VerticalScrollBarVisibility="Auto"
                                 PreviewKeyDown="MainInput_PreviewKeyDown"/>
                        <!-- Placeholder text -->
                        <TextBlock FontSize="12" Foreground="#9E9E9E" FontStyle="Italic"
                                   IsHitTestVisible="False" Padding="12,10,0,0"
                                   VerticalAlignment="Top" HorizontalAlignment="Left">
                            <TextBlock.Style>
                                <Style TargetType="TextBlock">
                                    <Setter Property="Visibility" Value="Collapsed"/>
                                    <Setter Property="Text" Value="â–¶ Enter a topic to start a panel discussion..."/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding Text, ElementName=MainInput}" Value="">
                                            <Setter Property="Visibility" Value="Visible"/>
                                        </DataTrigger>
                                        <DataTrigger Binding="{Binding IsDiscussionActive}" Value="True">
                                            <Setter Property="Text" Value="â–¶ Send a message to the Head agent..."/>
                                        </DataTrigger>
                                        <DataTrigger Binding="{Binding IsFollowUpAvailable}" Value="True">
                                            <Setter Property="Text" Value="â–¶ Ask a follow-up question..."/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </TextBlock.Style>
                        </TextBlock>
                    </Grid>

                    <!-- Submit button -->
                    <Button Grid.Column="1" Margin="8,0,0,0"
                            Style="{StaticResource ActionButton}"
                            Background="#1976D2" Foreground="White"
                            Command="{Binding StartDiscussionCommand}"
                            Visibility="{Binding IsDiscussionActive, Converter={StaticResource InverseBoolToVis}}">
                        <emoji:TextBlock Text="ðŸš€ Start"/>
                    </Button>

                    <!-- Send button (during discussion) -->
                    <Button Grid.Column="1" Margin="8,0,0,0"
                            Style="{StaticResource ActionButton}"
                            Background="#7B1FA2" Foreground="White"
                            Command="{Binding SendMessageCommand}"
                            Visibility="{Binding IsDiscussionActive, Converter={StaticResource BoolToVis}}">
                        <emoji:TextBlock Text="ðŸ’¬ Send"/>
                    </Button>
                </Grid>
            </Border>
        </Grid>

        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <!-- OVERLAY: Synthesis Report                                   -->
        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <Border Background="#60000000"
                Visibility="{Binding ShowSynthesis, Converter={StaticResource BoolToVis}}"
                MouseDown="SynthesisBackdrop_MouseDown">
            <Border Background="White" CornerRadius="10"
                    MaxWidth="750" MaxHeight="550"
                    HorizontalAlignment="Center" VerticalAlignment="Center"
                    Padding="24,20"
                    MouseDown="SynthesisPanel_MouseDown">
                <Border.Effect>
                    <DropShadowEffect BlurRadius="30" ShadowDepth="8" Opacity="0.2"/>
                </Border.Effect>
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>  <!-- Header -->
                        <RowDefinition Height="*"/>     <!-- Content -->
                        <RowDefinition Height="Auto"/>  <!-- Actions -->
                    </Grid.RowDefinitions>

                    <!-- Header -->
                    <Grid Grid.Row="0" Margin="0,0,0,12">
                        <StackPanel Orientation="Horizontal">
                            <emoji:TextBlock Text="ðŸ“Š" FontSize="20" VerticalAlignment="Center" Margin="0,0,8,0"/>
                            <TextBlock Text="Panel Synthesis Report" FontSize="18"
                                       FontWeight="SemiBold" Foreground="#212121"
                                       VerticalAlignment="Center"/>
                        </StackPanel>
                        <Button HorizontalAlignment="Right" Content="âœ•"
                                Style="{StaticResource IconButton}"
                                FontSize="14" Foreground="#757575"
                                Command="{Binding DismissSynthesisCommand}"/>
                    </Grid>

                    <!-- Report Content -->
                    <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto"
                                  Padding="4">
                        <mdxaml:MarkdownScrollViewer Markdown="{Binding SynthesisReport}"
                                                      Style="{StaticResource MdXamlStyle}"
                                                      VerticalScrollBarVisibility="Disabled"/>
                    </ScrollViewer>

                    <!-- Actions -->
                    <StackPanel Grid.Row="2" Orientation="Horizontal"
                                HorizontalAlignment="Right" Margin="0,12,0,0">
                        <Button Style="{StaticResource ActionButton}"
                                Background="#1976D2" Foreground="White"
                                Margin="0,0,8,0"
                                Command="{Binding CopySynthesisTextCommand}">
                            <emoji:TextBlock Text="ðŸ“‹ Copy"/>
                        </Button>
                        <Button Style="{StaticResource ActionButton}"
                                Background="#EEEEEE" Foreground="#424242"
                                Command="{Binding DismissSynthesisCommand}">
                            <emoji:TextBlock Text="âœ• Close"/>
                        </Button>
                    </StackPanel>
                </Grid>
            </Border>
        </Border>

        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <!-- OVERLAY: Backdrop + Side Panel (Settings & Event Log)       -->
        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->

        <!-- Semi-transparent backdrop -->
        <Border x:Name="Backdrop" Background="#40000000"
                Visibility="Collapsed"
                MouseDown="Backdrop_MouseDown"/>

        <!-- Side panel â€” slides in from right -->
        <Border x:Name="SidePanel"
                Width="550"
                HorizontalAlignment="Right"
                Background="White"
                BorderBrush="#E0E0E0" BorderThickness="1,0,0,0"
                Visibility="Collapsed">
            <Border.RenderTransform>
                <TranslateTransform X="550"/>
            </Border.RenderTransform>
            <Border.Effect>
                <DropShadowEffect Direction="180" BlurRadius="20" ShadowDepth="5" Opacity="0.15"/>
            </Border.Effect>

            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <!-- Panel Header -->
                <Border Grid.Row="0" Background="#F5F5F5" Padding="16,12"
                        BorderBrush="#E0E0E0" BorderThickness="0,0,0,1">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>

                        <StackPanel Grid.Column="0" Orientation="Horizontal" VerticalAlignment="Center">
                            <emoji:TextBlock Text="âš™ Panel Settings" FontSize="15"
                                       FontWeight="SemiBold" Foreground="#212121"/>
                            <Border CornerRadius="8" Padding="6,2" Margin="10,0,0,0"
                                    Background="#FFF3E0"
                                    Visibility="{Binding SettingsRequireRestart, Converter={StaticResource BoolToVis}}">
                                <TextBlock Text="âš  PENDING â€” Reset to apply" FontSize="10"
                                           FontWeight="SemiBold" Foreground="#E65100"/>
                            </Border>
                        </StackPanel>

                        <Button Grid.Column="1" Content="âœ•"
                                Style="{StaticResource IconButton}"
                                FontSize="14" Foreground="#757575"
                                Command="{Binding ToggleSidePanelCommand}"/>
                    </Grid>
                </Border>

                <!-- Scrollable content -->
                <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto" Padding="16,12">
                    <StackPanel>

                        <!-- â•â• Model Selection â•â• -->
                        <TextBlock Text="ðŸ§  Model Selection" Style="{StaticResource SidePanelSectionHeader}"/>

                        <StackPanel Margin="0,0,0,12">
                            <TextBlock Text="Primary Model:" Style="{StaticResource SettingsLabel}" Margin="0,0,0,4"/>
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>
                                <ComboBox Grid.Column="0"
                                          ItemsSource="{Binding AvailableModels}"
                                          Text="{Binding SettingsPrimaryModel, UpdateSourceTrigger=PropertyChanged}"
                                          IsEditable="True" FontSize="12" Padding="6,4"
                                          VerticalAlignment="Center"/>
                                <Button Grid.Column="1" Margin="6,0,0,0"
                                        Style="{StaticResource IconButton}"
                                        Command="{Binding RefreshModelsCommand}"
                                        ToolTip="Refresh available models"
                                        Padding="4">
                                    <emoji:TextBlock Text="ðŸ”„" FontSize="12"/>
                                </Button>
                            </Grid>
                        </StackPanel>

                        <Separator Background="#E0E0E0" Margin="0,0,0,12"/>

                        <!-- â•â• Panel Settings â•â• -->
                        <Grid Margin="0,0,0,10">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <TextBlock Grid.Column="0" Text="ðŸŽ™ Panel Configuration"
                                       Style="{StaticResource SidePanelSectionHeader}"/>
                            <Button Grid.Column="1"
                                    Style="{StaticResource ActionButton}"
                                    Background="#E0E0E0" Foreground="#616161"
                                    Padding="8,3" FontSize="11"
                                    Command="{Binding RestoreDefaultSettingsCommand}"
                                    ToolTip="Reset all settings to defaults">
                                <TextBlock Text="â†© Defaults"/>
                            </Button>
                        </Grid>

                        <!-- Max Panelists + Max Turns -->
                        <Grid Margin="0,0,0,8">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>

                            <StackPanel Grid.Column="0" Margin="0,0,8,0">
                                <TextBlock Text="Max Panelists:" Style="{StaticResource SettingsLabel}" Margin="0,0,0,4"/>
                                <ComboBox ItemsSource="{Binding PanelistOptions}"
                                          SelectedItem="{Binding SettingsMaxPanelists}"
                                          FontSize="12" Padding="6,4"/>
                            </StackPanel>

                            <StackPanel Grid.Column="1" Margin="8,0,0,0">
                                <TextBlock Text="Max Turns:" Style="{StaticResource SettingsLabel}" Margin="0,0,0,4"/>
                                <ComboBox ItemsSource="{Binding TurnOptions}"
                                          SelectedItem="{Binding SettingsMaxTurns}"
                                          FontSize="12" Padding="6,4"/>
                            </StackPanel>
                        </Grid>

                        <!-- Duration + Convergence Threshold -->
                        <Grid Margin="0,0,0,8">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>

                            <StackPanel Grid.Column="0" Margin="0,0,8,0">
                                <TextBlock Text="Max Duration (min):" Style="{StaticResource SettingsLabel}" Margin="0,0,0,4"/>
                                <ComboBox ItemsSource="{Binding DurationOptions}"
                                          SelectedItem="{Binding SettingsMaxDurationMinutes}"
                                          FontSize="12" Padding="6,4"/>
                            </StackPanel>

                            <StackPanel Grid.Column="1" Margin="8,0,0,0">
                                <TextBlock Text="Convergence (%):" Style="{StaticResource SettingsLabel}" Margin="0,0,0,4"/>
                                <TextBox Text="{Binding SettingsConvergenceThreshold, UpdateSourceTrigger=PropertyChanged}"
                                         FontSize="12" Padding="6,4"
                                         HorizontalContentAlignment="Center"/>
                            </StackPanel>
                        </Grid>

                        <!-- Commentary Mode -->
                        <StackPanel Margin="0,0,0,8">
                            <TextBlock Text="Commentary Mode:" Style="{StaticResource SettingsLabel}" Margin="0,0,0,4"/>
                            <ComboBox ItemsSource="{Binding CommentaryModes}"
                                      SelectedItem="{Binding SettingsCommentaryMode}"
                                      FontSize="12" Padding="6,4"/>
                        </StackPanel>

                        <!-- Allow File System Access -->
                        <StackPanel Orientation="Horizontal" Margin="0,4,0,12">
                            <CheckBox IsChecked="{Binding SettingsAllowFileSystemAccess}"
                                      VerticalAlignment="Center" Margin="0,0,6,0"/>
                            <TextBlock Text="Allow file system access for tools"
                                       Style="{StaticResource SettingsLabel}"/>
                        </StackPanel>

                        <!-- Apply / Discard buttons -->
                        <Border Background="#FAFAFA" CornerRadius="6" Padding="12,10" Margin="0,0,0,12"
                                BorderBrush="#E0E0E0" BorderThickness="1"
                                Visibility="{Binding HasPendingChanges, Converter={StaticResource BoolToVis}}">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>

                                <StackPanel Grid.Column="0" Orientation="Horizontal" VerticalAlignment="Center">
                                    <Border CornerRadius="8" Padding="6,2" Background="#FFF3E0">
                                        <TextBlock FontSize="11" FontWeight="SemiBold" Foreground="#E65100">
                                            <Run Text="{Binding PendingChangesCount, Mode=OneWay}"/>
                                            <Run Text=" unsaved change(s)"/>
                                        </TextBlock>
                                    </Border>
                                </StackPanel>

                                <Button Grid.Column="1" Margin="8,0,4,0"
                                        Style="{StaticResource ActionButton}"
                                        Background="#4CAF50" Foreground="White"
                                        Padding="12,6" FontSize="12"
                                        Command="{Binding ApplySettingsCommand}">
                                    <TextBlock Text="âœ“ Apply"/>
                                </Button>

                                <Button Grid.Column="2"
                                        Style="{StaticResource ActionButton}"
                                        Background="#E0E0E0" Foreground="#616161"
                                        Padding="12,6" FontSize="12"
                                        Command="{Binding DiscardSettingsCommand}">
                                    <TextBlock Text="âœ• Discard"/>
                                </Button>
                            </Grid>
                        </Border>

                        <Separator Background="#E0E0E0" Margin="0,0,0,12"/>

                        <!-- â•â• Event Log â•â• -->
                        <TextBlock Text="ðŸ“ Event Log" Style="{StaticResource SidePanelSectionHeader}"/>

                        <Border Background="#FAFAFA" CornerRadius="4" Padding="8"
                                BorderBrush="#E0E0E0" BorderThickness="1"
                                MaxHeight="350">
                            <ListBox ItemsSource="{Binding EventLog}"
                                     BorderThickness="0" Background="Transparent"
                                     FontFamily="Cascadia Code, Consolas, Courier New"
                                     FontSize="11" Foreground="#616161"
                                     ScrollViewer.VerticalScrollBarVisibility="Auto"
                                     ScrollViewer.CanContentScroll="True"/>
                        </Border>

                    </StackPanel>
                </ScrollViewer>
            </Grid>
        </Border>
    </Grid>
</UserControl>