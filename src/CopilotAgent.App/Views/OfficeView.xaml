<UserControl x:Class="CopilotAgent.App.Views.OfficeView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:converters="clr-namespace:CopilotAgent.App.Converters"
             xmlns:helpers="clr-namespace:CopilotAgent.App.Helpers"
             xmlns:emoji="clr-namespace:Emoji.Wpf;assembly=Emoji.Wpf"
             xmlns:mdxaml="clr-namespace:MdXaml;assembly=MdXaml"
             mc:Ignorable="d"
             d:DesignHeight="700" d:DesignWidth="950"
             Background="White">

    <UserControl.Resources>
        <converters:BoolToVisibilityConverter x:Key="BoolToVis"/>
        <converters:InverseBoolToVisibilityConverter x:Key="InverseBoolToVis"/>
        <converters:StringToBrushConverter x:Key="StringToBrush"/>
        <converters:StringToVisibilityConverter x:Key="StringToVis"/>
        <converters:ZeroCountToVisibilityConverter x:Key="NonZeroToVis"/>

        <!-- MdXaml Markdown style for modern rich-text rendering in chat bubbles -->
        <Style x:Key="OfficeMdStyle" TargetType="mdxaml:MarkdownScrollViewer">
            <Setter Property="MarkdownStyleName" Value="Standard"/>
            <Setter Property="VerticalScrollBarVisibility" Value="Disabled"/>
            <Setter Property="HorizontalScrollBarVisibility" Value="Disabled"/>
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Padding" Value="0"/>
            <Setter Property="Margin" Value="0"/>
            <Setter Property="FontSize" Value="13"/>
        </Style>

        <!-- Selectable read-only TextBox style: enables mouse selection + right-click Copy everywhere -->
        <Style x:Key="SelectableText" TargetType="TextBox">
            <Setter Property="IsReadOnly" Value="True"/>
            <Setter Property="IsReadOnlyCaretVisible" Value="True"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Padding" Value="0"/>
            <Setter Property="Cursor" Value="IBeam"/>
            <Setter Property="TextWrapping" Value="Wrap"/>
            <Setter Property="SelectionBrush" Value="#FF3399FF"/>
            <Setter Property="SelectionOpacity" Value="0.4"/>
            <Setter Property="ContextMenu">
                <Setter.Value>
                    <ContextMenu>
                        <MenuItem Header="Copy" Command="ApplicationCommands.Copy"/>
                        <MenuItem Header="Select All" Command="ApplicationCommands.SelectAll"/>
                    </ContextMenu>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- Action button style (reused from AgentTeamView pattern) -->
        <Style x:Key="ActionButton" TargetType="Button">
            <Setter Property="Padding" Value="14,7"/>
            <Setter Property="FontSize" Value="13"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="ActionBorder"
                                Background="{TemplateBinding Background}"
                                CornerRadius="4"
                                Padding="{TemplateBinding Padding}">
                            <ContentPresenter HorizontalAlignment="Center"
                                              VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter TargetName="ActionBorder" Property="Opacity" Value="0.4"/>
                            </Trigger>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="ActionBorder" Property="Opacity" Value="0.85"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="IconButton" TargetType="Button">
            <Setter Property="Padding" Value="6,4"/>
            <Setter Property="FontSize" Value="15"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border Background="{TemplateBinding Background}"
                                CornerRadius="4"
                                Padding="{TemplateBinding Padding}">
                            <ContentPresenter HorizontalAlignment="Center"
                                              VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter Property="Background" Value="#E0E0E0"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <!-- DataTemplates for each OfficeChatRole              -->
        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->

        <!-- USER message: right-aligned, green accent -->
        <DataTemplate x:Key="UserMessageTemplate">
            <Border HorizontalAlignment="Right" MaxWidth="600" Margin="80,4,16,4"
                    Background="#E8F5E9" CornerRadius="12,12,2,12" Padding="14,10">
                <StackPanel>
                    <TextBox Style="{StaticResource SelectableText}" Text="{Binding SenderName, Mode=OneWay}"
                             FontSize="11" FontWeight="SemiBold" Foreground="#2E7D32" Margin="0,0,0,4"/>
                    <mdxaml:MarkdownScrollViewer Markdown="{Binding Content, Mode=OneWay}"
                                                 Style="{StaticResource OfficeMdStyle}"
                                                 Foreground="#212121"/>
                    <TextBox Style="{StaticResource SelectableText}" Text="{Binding Timestamp, StringFormat='{}{0:HH:mm}', Mode=OneWay}"
                             FontSize="10" Foreground="#9E9E9E" HorizontalAlignment="Right"
                             Margin="0,4,0,0"/>
                </StackPanel>
            </Border>
        </DataTemplate>

        <!-- MANAGER message: left-aligned, blue accent, collapsible, with copy button -->
        <DataTemplate x:Key="ManagerMessageTemplate">
            <Border HorizontalAlignment="Left" MaxWidth="650" Margin="16,4,80,4"
                    CornerRadius="12,12,12,2" Padding="14,10"
                    Background="#E3F2FD" BorderBrush="#90CAF9" BorderThickness="1">
                <StackPanel>
                    <StackPanel Orientation="Horizontal" Margin="0,0,0,4">
                        <emoji:TextBlock Text="ðŸ§‘â€ðŸ’¼" FontSize="13" Margin="0,0,6,0" VerticalAlignment="Center"/>
                        <TextBox Style="{StaticResource SelectableText}" Text="{Binding SenderName, Mode=OneWay}"
                                 FontSize="11" FontWeight="SemiBold" Foreground="#1565C0"
                                 VerticalAlignment="Center"/>
                        <TextBox Style="{StaticResource SelectableText}" Text="{Binding Timestamp, StringFormat=' Â· {0:HH:mm}', Mode=OneWay}"
                                 FontSize="10" Foreground="#9E9E9E" VerticalAlignment="Center"
                                 Margin="6,0,0,0"/>
                    </StackPanel>
                    <mdxaml:MarkdownScrollViewer Markdown="{Binding Content, Mode=OneWay}"
                                                 Style="{StaticResource OfficeMdStyle}"
                                                 Foreground="#212121"/>
                    <!-- Copy to clipboard button -->
                    <Button HorizontalAlignment="Right" Margin="0,6,0,0"
                            Style="{StaticResource IconButton}"
                            ToolTip="Copy to clipboard"
                            Tag="{Binding Content, Mode=OneWay}"
                            Click="CopyContent_Click">
                        <StackPanel Orientation="Horizontal">
                            <TextBlock Text="ðŸ“‹" FontSize="12" Margin="0,0,4,0"/>
                            <TextBlock Text="Copy" FontSize="10" Foreground="#757575"
                                       VerticalAlignment="Center"/>
                        </StackPanel>
                    </Button>
                </StackPanel>
            </Border>
        </DataTemplate>

        <!-- ASSISTANT message: left-aligned, indented, per-color accent, collapsible, with copy button -->
        <DataTemplate x:Key="AssistantMessageTemplate">
            <Border HorizontalAlignment="Left" MaxWidth="600" Margin="40,4,80,4"
                    CornerRadius="8" Padding="12,10"
                    BorderThickness="2,0,0,0"
                    BorderBrush="{Binding AccentColor, Converter={StaticResource StringToBrush}}"
                    Background="#FAFAFA">
                <StackPanel>
                    <StackPanel Orientation="Horizontal" Margin="0,0,0,4">
                        <Ellipse Width="8" Height="8" Margin="0,0,6,0" VerticalAlignment="Center"
                                 Fill="{Binding AccentColor, Converter={StaticResource StringToBrush}}"/>
                        <TextBox Style="{StaticResource SelectableText}" Text="{Binding SenderName, Mode=OneWay}"
                                 FontSize="11" FontWeight="SemiBold"
                                 Foreground="{Binding AccentColor, Converter={StaticResource StringToBrush}}"
                                 VerticalAlignment="Center"/>
                        <TextBox Style="{StaticResource SelectableText}" Text="{Binding Timestamp, StringFormat=' Â· {0:HH:mm}', Mode=OneWay}"
                                 FontSize="10" Foreground="#9E9E9E" VerticalAlignment="Center"
                                 Margin="6,0,0,0"/>
                    </StackPanel>
                    <mdxaml:MarkdownScrollViewer Markdown="{Binding Content, Mode=OneWay}"
                                                 Style="{StaticResource OfficeMdStyle}"
                                                 Foreground="#424242"/>
                    <!-- Copy to clipboard button -->
                    <Button HorizontalAlignment="Right" Margin="0,6,0,0"
                            Style="{StaticResource IconButton}"
                            ToolTip="Copy to clipboard"
                            Tag="{Binding Content, Mode=OneWay}"
                            Click="CopyContent_Click">
                        <StackPanel Orientation="Horizontal">
                            <TextBlock Text="ðŸ“‹" FontSize="12" Margin="0,0,4,0"/>
                            <TextBlock Text="Copy" FontSize="10" Foreground="#757575"
                                       VerticalAlignment="Center"/>
                        </StackPanel>
                    </Button>
                </StackPanel>
            </Border>
        </DataTemplate>

        <!-- SYSTEM message: centered, grey -->
        <DataTemplate x:Key="SystemMessageTemplate">
            <Border HorizontalAlignment="Center" Margin="16,8,16,8"
                    Background="#F5F5F5" CornerRadius="16" Padding="16,6">
                <mdxaml:MarkdownScrollViewer Markdown="{Binding Content, Mode=OneWay}"
                                             Style="{StaticResource OfficeMdStyle}"
                                             Foreground="#757575" FontSize="12"
                                             HorizontalAlignment="Center"/>
            </Border>
        </DataTemplate>

        <!-- ITERATION HEADER: separator with iteration number -->
        <DataTemplate x:Key="IterationHeaderTemplate">
            <Border Margin="0,6,0,2">
                <Grid>
                    <Separator VerticalAlignment="Center" Background="#E0E0E0"/>
                    <Border HorizontalAlignment="Center" Background="White" Padding="8,1">
                        <StackPanel Orientation="Horizontal">
                            <emoji:TextBlock Text="ðŸ”„" FontSize="11" VerticalAlignment="Center" Margin="0,0,4,0"/>
                            <TextBlock FontSize="11" FontWeight="SemiBold" Foreground="#1976D2">
                                <Run Text="Iteration #"/>
                                <Run Text="{Binding IterationNumber, Mode=OneWay}"/>
                            </TextBlock>
                            <TextBlock Text="{Binding Timestamp, StringFormat=' Â· {0:HH:mm}'}"
                                       FontSize="10" Foreground="#9E9E9E" VerticalAlignment="Center"
                                       Margin="8,0,0,0"/>
                        </StackPanel>
                    </Border>
                </Grid>
            </Border>
        </DataTemplate>

        <!-- REST COUNTDOWN: progress bar + text -->
        <DataTemplate x:Key="RestCountdownTemplate">
            <Border HorizontalAlignment="Center" Margin="16,6,16,6"
                    Background="#ECEFF1" CornerRadius="12" Padding="16,8">
                <StackPanel Orientation="Horizontal">
                    <emoji:TextBlock Text="ðŸ˜´" FontSize="14" VerticalAlignment="Center" Margin="0,0,8,0"/>
                    <TextBlock Text="Resting..." FontSize="12" Foreground="#78909C"
                               VerticalAlignment="Center" Margin="0,0,8,0"/>
                    <TextBlock Text="{Binding Content}" FontSize="12" FontWeight="SemiBold"
                               Foreground="#546E7A" VerticalAlignment="Center"/>
                </StackPanel>
            </Border>
        </DataTemplate>

        <!-- Template Selector -->
        <helpers:OfficeChatMessageTemplateSelector x:Key="MessageTemplateSelector"
            UserTemplate="{StaticResource UserMessageTemplate}"
            ManagerTemplate="{StaticResource ManagerMessageTemplate}"
            AssistantTemplate="{StaticResource AssistantMessageTemplate}"
            SystemTemplate="{StaticResource SystemMessageTemplate}"
            IterationHeaderTemplate="{StaticResource IterationHeaderTemplate}"
            RestCountdownTemplate="{StaticResource RestCountdownTemplate}"/>

        <!-- Side panel slide-in/slide-out storyboards -->
        <Storyboard x:Key="SlideInStoryboard">
            <DoubleAnimation Storyboard.TargetName="SidePanelTransform"
                             Storyboard.TargetProperty="X"
                             From="550" To="0" Duration="0:0:0.3">
                <DoubleAnimation.EasingFunction>
                    <QuarticEase EasingMode="EaseOut"/>
                </DoubleAnimation.EasingFunction>
            </DoubleAnimation>
            <DoubleAnimation Storyboard.TargetName="Backdrop"
                             Storyboard.TargetProperty="Opacity"
                             From="0" To="1" Duration="0:0:0.25"/>
        </Storyboard>

        <!-- Activity status pulse animation (Issue #7): opacity 1.0 â†” 0.4 over 1.5s -->
        <Storyboard x:Key="PulseStoryboard" RepeatBehavior="Forever" AutoReverse="True">
            <DoubleAnimation Storyboard.TargetName="ActivityStatusPanel"
                             Storyboard.TargetProperty="Opacity"
                             From="1.0" To="0.4" Duration="0:0:1.5">
                <DoubleAnimation.EasingFunction>
                    <SineEase EasingMode="EaseInOut"/>
                </DoubleAnimation.EasingFunction>
            </DoubleAnimation>
        </Storyboard>

        <Storyboard x:Key="SlideOutStoryboard">
            <DoubleAnimation Storyboard.TargetName="SidePanelTransform"
                             Storyboard.TargetProperty="X"
                             From="0" To="550" Duration="0:0:0.25">
                <DoubleAnimation.EasingFunction>
                    <QuarticEase EasingMode="EaseIn"/>
                </DoubleAnimation.EasingFunction>
            </DoubleAnimation>
            <DoubleAnimation Storyboard.TargetName="Backdrop"
                             Storyboard.TargetProperty="Opacity"
                             From="1" To="0" Duration="0:0:0.2"/>
        </Storyboard>
    </UserControl.Resources>

    <!-- Root grid for main content + overlay -->
    <Grid>
        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <!-- Main Content (3 rows)                               -->
        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <Grid>
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>  <!-- Status bar -->
                <RowDefinition Height="*"/>     <!-- Chat ScrollViewer -->
                <RowDefinition Height="Auto"/>  <!-- Input area -->
            </Grid.RowDefinitions>

            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <!-- Row 0: Status Bar                              -->
            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <Border Grid.Row="0" Background="#F5F5F5" Padding="14,8"
                    BorderBrush="#E0E0E0" BorderThickness="0,0,0,1">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto"/>  <!-- Phase pill -->
                        <ColumnDefinition Width="Auto"/>  <!-- Iteration -->
                        <ColumnDefinition Width="Auto"/>  <!-- Task progress -->
                        <ColumnDefinition Width="Auto"/>  <!-- Queue -->
                        <ColumnDefinition Width="*"/>     <!-- Spacer / rest countdown -->
                        <ColumnDefinition Width="Auto"/>  <!-- Side panel toggle -->
                    </Grid.ColumnDefinitions>

                    <!-- Phase Pill -->
                    <Border Grid.Column="0" CornerRadius="10" Padding="10,4"
                            Background="{Binding CurrentPhaseColor, Converter={StaticResource StringToBrush}}"
                            VerticalAlignment="Center" Margin="0,0,10,0">
                        <TextBlock Text="{Binding CurrentPhaseDisplay}" FontSize="11"
                                   FontWeight="SemiBold" Foreground="White"/>
                    </Border>

                    <!-- Iteration Counter -->
                    <StackPanel Grid.Column="1" Orientation="Horizontal" VerticalAlignment="Center"
                                Margin="0,0,14,0">
                        <emoji:TextBlock Text="ðŸ”„" FontSize="12" VerticalAlignment="Center" Margin="0,0,4,0"/>
                        <TextBlock FontSize="12" Foreground="#424242" VerticalAlignment="Center">
                            <Run Text="Iter "/>
                            <Run Text="{Binding CurrentIteration, Mode=OneWay}" FontWeight="SemiBold"/>
                        </TextBlock>
                    </StackPanel>

                    <!-- Task Progress -->
                    <StackPanel Grid.Column="2" Orientation="Horizontal" VerticalAlignment="Center"
                                Margin="0,0,14,0">
                        <TextBlock FontSize="11" Foreground="#616161" VerticalAlignment="Center"
                                   Margin="0,0,6,0">
                            <Run Text="{Binding CompletedTasks, Mode=OneWay}"/>
                            <Run Text="/"/>
                            <Run Text="{Binding TotalTasks, Mode=OneWay}"/>
                            <Run Text=" tasks"/>
                        </TextBlock>
                        <ProgressBar Width="60" Height="6" Minimum="0" Maximum="100"
                                     Value="{Binding TaskProgressPercent, Mode=OneWay}"
                                     Foreground="#4CAF50" Background="#E0E0E0"
                                     VerticalAlignment="Center"/>
                    </StackPanel>

                    <!-- Queue Depth -->
                    <Border Grid.Column="3" CornerRadius="8" Padding="8,3"
                            Background="#FFF3E0" VerticalAlignment="Center" Margin="0,0,14,0"
                            Visibility="{Binding QueueDepth, Converter={StaticResource NonZeroToVis}}">
                        <TextBlock FontSize="11" Foreground="#E65100">
                            <Run Text="Q: "/>
                            <Run Text="{Binding QueueDepth, Mode=OneWay}" FontWeight="SemiBold"/>
                        </TextBlock>
                    </Border>

                    <!-- Model Indicators (center-left of spacer) -->
                    <StackPanel Grid.Column="4" Orientation="Horizontal" VerticalAlignment="Center"
                                HorizontalAlignment="Left" Margin="8,0,0,0"
                                Visibility="{Binding IsRunning, Converter={StaticResource BoolToVis}}">
                        <Border Background="#E8EAF6" CornerRadius="6" Padding="6,3" Margin="0,0,6,0">
                            <TextBlock FontSize="10" Foreground="#3F51B5" FontFamily="Cascadia Code, Consolas">
                                <Run Text="M:" FontWeight="Bold"/>
                                <Run Text="{Binding SelectedManagerModel, Mode=OneWay}"/>
                            </TextBlock>
                        </Border>
                        <Border Background="#F3E5F5" CornerRadius="6" Padding="6,3">
                            <TextBlock FontSize="10" Foreground="#7B1FA2" FontFamily="Cascadia Code, Consolas">
                                <Run Text="A:" FontWeight="Bold"/>
                                <Run Text="{Binding SelectedAssistantModel, Mode=OneWay}"/>
                            </TextBlock>
                        </Border>
                    </StackPanel>

                    <!-- Rest Countdown (center area) -->
                    <StackPanel Grid.Column="4" Orientation="Horizontal" HorizontalAlignment="Center"
                                VerticalAlignment="Center"
                                Visibility="{Binding IsResting, Converter={StaticResource BoolToVis}}">
                        <emoji:TextBlock Text="ðŸ˜´" FontSize="13" VerticalAlignment="Center" Margin="0,0,6,0"/>
                        <TextBlock Text="{Binding RestCountdownText}" FontSize="12" FontWeight="SemiBold"
                                   Foreground="#78909C" VerticalAlignment="Center" Margin="0,0,8,0"/>
                        <ProgressBar Width="80" Height="5" Minimum="0" Maximum="100"
                                     Value="{Binding RestProgressPercent, Mode=OneWay}"
                                     Foreground="#78909C" Background="#E0E0E0"
                                     VerticalAlignment="Center" Margin="0,0,8,0"/>
                        <Button Style="{StaticResource IconButton}" ToolTip="Skip rest"
                                Command="{Binding SkipRestCommand}" Padding="4,2">
                            <emoji:TextBlock Text="â­" FontSize="12"/>
                        </Button>
                    </StackPanel>

                    <!-- Side Panel Toggle -->
                    <Button Grid.Column="5" Style="{StaticResource IconButton}"
                            Command="{Binding ToggleSidePanelCommand}"
                            ToolTip="Toggle side panel">
                        <emoji:TextBlock Text="ðŸ“Š" FontSize="15"/>
                    </Button>
                </Grid>
            </Border>

            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <!-- Row 1: Chat ScrollViewer                       -->
            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <ScrollViewer x:Name="ChatScrollViewer" Grid.Row="1"
                          VerticalScrollBarVisibility="Auto"
                          Padding="0,8,0,8"
                          PreviewMouseWheel="ChatScrollViewer_PreviewMouseWheel">
                <StackPanel>
                    <!-- Error message -->
                    <Border Background="#FFEBEE" CornerRadius="4" Padding="12,8" Margin="16,4,16,4"
                            Visibility="{Binding ErrorMessage, Converter={StaticResource StringToVis}}">
                        <TextBox Style="{StaticResource SelectableText}" Text="{Binding ErrorMessage, Mode=OneWay}"
                                 Foreground="#C62828" FontSize="13"/>
                    </Border>

                    <!-- Messages ItemsControl (Bug #6 fix: moved before approval panel) -->
                    <ItemsControl ItemsSource="{Binding Messages}"
                                  ItemTemplateSelector="{StaticResource MessageTemplateSelector}">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <StackPanel/>
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                    </ItemsControl>

                    <!-- Bug #6 fix: Plan Approval Panel AFTER messages so it appears at bottom -->
                    <Border Background="#E8EAF6" CornerRadius="8" Padding="16,12" Margin="16,8,16,8"
                            Visibility="{Binding IsPlanAwaitingApproval, Converter={StaticResource BoolToVis}}">
                        <StackPanel>
                            <StackPanel Orientation="Horizontal" Margin="0,0,0,8">
                                <emoji:TextBlock Text="ðŸ“‹" FontSize="16" VerticalAlignment="Center" Margin="0,0,8,0"/>
                                <TextBlock Text="Plan Awaiting Approval" FontSize="14"
                                           FontWeight="SemiBold" Foreground="#283593"/>
                            </StackPanel>
                            <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                                <Button Style="{StaticResource ActionButton}"
                                        Background="#4CAF50" Foreground="White"
                                        Command="{Binding ApprovePlanCommand}" Margin="0,0,8,0">
                                    <emoji:TextBlock Text="âœ… Approve"/>
                                </Button>
                                <Button Style="{StaticResource ActionButton}"
                                        Background="#F44336" Foreground="White"
                                        Command="{Binding RejectPlanCommand}">
                                    <emoji:TextBlock Text="âŒ Reject"/>
                                </Button>
                            </StackPanel>
                        </StackPanel>
                    </Border>
                </StackPanel>
            </ScrollViewer>

            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <!-- Row 2: Input Area                              -->
            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <Border Grid.Row="2" Background="#F5F5F5" Padding="14,10"
                    BorderBrush="#E0E0E0" BorderThickness="0,1,0,0">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>  <!-- Activity status -->
                        <RowDefinition Height="Auto"/>  <!-- Clarification -->
                        <RowDefinition Height="Auto"/>  <!-- Input row -->
                    </Grid.RowDefinitions>

                    <!-- Issue #7: Activity Status Panel (pulsing indicator) -->
                    <Border x:Name="ActivityStatusPanel" Grid.Row="0"
                            CornerRadius="6" Padding="10,7" Margin="0,0,0,6"
                            Background="#EDE7F6" BorderBrush="#B39DDB" BorderThickness="1"
                            Visibility="{Binding IsActivityStatusVisible, Converter={StaticResource BoolToVis}}">
                        <StackPanel Orientation="Horizontal">
                            <emoji:TextBlock Text="âš¡" FontSize="14" VerticalAlignment="Center" Margin="0,0,8,0"/>
                            <TextBlock Text="{Binding ActivityStatusText}"
                                       FontSize="12" Foreground="#4527A0" FontWeight="SemiBold"
                                       VerticalAlignment="Center" TextWrapping="Wrap"/>
                        </StackPanel>
                    </Border>

                    <!-- Clarification indicator -->
                    <Border Grid.Row="1" CornerRadius="6" Padding="10,6" Margin="0,0,0,6"
                            Background="#FFF8E1" BorderBrush="#FFE082" BorderThickness="1"
                            Visibility="{Binding IsWaitingForClarification, Converter={StaticResource BoolToVis}}">
                        <StackPanel Orientation="Horizontal">
                            <emoji:TextBlock Text="ðŸ¤”" FontSize="14" VerticalAlignment="Center" Margin="0,0,8,0"/>
                            <TextBlock Text="Manager is asking for clarification â€” please respond below"
                                       FontSize="12" Foreground="#F57F17" FontWeight="SemiBold"
                                       VerticalAlignment="Center"/>
                        </StackPanel>
                    </Border>

                    <!-- Input row: either objective (when idle) or message (when running) -->
                    <Grid Grid.Row="2">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>

                        <!-- Objective input (when NOT running) -->
                        <Grid Grid.Column="0"
                              Visibility="{Binding IsRunning, Converter={StaticResource InverseBoolToVis}}">
                            <TextBox x:Name="ObjectiveTextBox"
                                     Text="{Binding ObjectiveInput, UpdateSourceTrigger=PropertyChanged}"
                                     Padding="10,8" FontSize="13"
                                     BorderBrush="#BDBDBD" BorderThickness="1"
                                     ToolTip="Enter your objective for the Agent Office"
                                     AcceptsReturn="True"
                                     TextWrapping="Wrap"
                                     MaxHeight="100"
                                     VerticalScrollBarVisibility="Auto"
                                     PreviewKeyDown="ObjectiveInput_PreviewKeyDown"/>
                            <TextBlock Text="&#x25B6; Enter to start &amp; Shift+Enter to add new line.."
                                       FontSize="12" Foreground="#9E9E9E" FontStyle="Italic"
                                       IsHitTestVisible="False" Padding="12,10,0,0"
                                       VerticalAlignment="Top" HorizontalAlignment="Left">
                                <TextBlock.Style>
                                    <Style TargetType="TextBlock">
                                        <Setter Property="Visibility" Value="Collapsed"/>
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding Text, ElementName=ObjectiveTextBox}" Value="">
                                                <Setter Property="Visibility" Value="Visible"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </TextBlock.Style>
                            </TextBlock>
                        </Grid>

                        <!-- Message input (when running) -->
                        <Grid Grid.Column="0"
                              Visibility="{Binding IsRunning, Converter={StaticResource BoolToVis}}">
                            <TextBox x:Name="MessageTextBox"
                                     Text="{Binding MessageInput, UpdateSourceTrigger=PropertyChanged}"
                                     Padding="10,8" FontSize="13"
                                     AcceptsReturn="True"
                                     TextWrapping="Wrap"
                                     MaxHeight="100"
                                     VerticalScrollBarVisibility="Auto"
                                     PreviewKeyDown="MessageInput_PreviewKeyDown"
                                     ToolTip="Send instructions or respond to clarification">
                                <TextBox.Style>
                                    <Style TargetType="TextBox">
                                        <Setter Property="BorderBrush" Value="#BDBDBD"/>
                                        <Setter Property="BorderThickness" Value="1"/>
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding IsWaitingForClarification}" Value="True">
                                                <Setter Property="BorderBrush" Value="#FFA726"/>
                                                <Setter Property="BorderThickness" Value="2"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </TextBox.Style>
                            </TextBox>
                            <TextBlock Text="&#x25B6; Enter to send &amp; Shift+Enter to add new line.."
                                       FontSize="12" Foreground="#9E9E9E" FontStyle="Italic"
                                       IsHitTestVisible="False" Padding="12,10,0,0"
                                       VerticalAlignment="Top" HorizontalAlignment="Left">
                                <TextBlock.Style>
                                    <Style TargetType="TextBlock">
                                        <Setter Property="Visibility" Value="Collapsed"/>
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding Text, ElementName=MessageTextBox}" Value="">
                                                <Setter Property="Visibility" Value="Visible"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </TextBlock.Style>
                            </TextBlock>
                        </Grid>

                        <!-- Start button (when not running) -->
                        <Button Grid.Column="1" Margin="8,0,0,0"
                                Style="{StaticResource ActionButton}"
                                Background="#1976D2" Foreground="White"
                                Command="{Binding StartCommand}"
                                Visibility="{Binding IsRunning, Converter={StaticResource InverseBoolToVis}}">
                            <emoji:TextBlock Text="ðŸš€ Start"/>
                        </Button>

                        <!-- Send button (when running) -->
                        <Button Grid.Column="1" Margin="8,0,0,0"
                                Style="{StaticResource ActionButton}"
                                Background="#7B1FA2" Foreground="White"
                                Command="{Binding SendMessageCommand}"
                                Visibility="{Binding IsRunning, Converter={StaticResource BoolToVis}}">
                            <emoji:TextBlock Text="ðŸ“¨ Send"/>
                        </Button>

                        <!-- Pause/Resume (when running) -->
                        <Button Grid.Column="2" Margin="6,0,0,0"
                                Style="{StaticResource ActionButton}"
                                Background="#FF9800" Foreground="White"
                                Command="{Binding PauseCommand}"
                                Visibility="{Binding IsRunning, Converter={StaticResource BoolToVis}}"
                                ToolTip="Pause iteration loop">
                            <emoji:TextBlock Text="â¸ Pause"/>
                        </Button>

                        <!-- Stop (when running) -->
                        <Button Grid.Column="3" Margin="6,0,0,0"
                                Style="{StaticResource ActionButton}"
                                Background="#D32F2F" Foreground="White"
                                Command="{Binding StopCommand}"
                                Visibility="{Binding IsRunning, Converter={StaticResource BoolToVis}}"
                                ToolTip="Stop the office">
                            <emoji:TextBlock Text="â¹ Stop"/>
                        </Button>

                        <!-- Bug #7 fix: Reset button accessible in input area (when not running) -->
                        <Button Grid.Column="2" Margin="6,0,0,0"
                                Style="{StaticResource ActionButton}"
                                Background="#9E9E9E" Foreground="White"
                                Command="{Binding ResetCommand}"
                                Visibility="{Binding IsRunning, Converter={StaticResource InverseBoolToVis}}"
                                ToolTip="Reset the office">
                            <emoji:TextBlock Text="ðŸ”„ Reset"/>
                        </Button>
                    </Grid>
                </Grid>
            </Border>
        </Grid>

        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <!-- Overlay: Backdrop + Side Panel                      -->
        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->

        <!-- Backdrop (dimmed click-to-close) â€” visibility managed by code-behind for animations -->
        <Border x:Name="Backdrop" Background="#40000000"
                MouseDown="Backdrop_MouseDown"
                Visibility="Collapsed"
                Opacity="0"/>

        <!-- Side Panel (400px, slides from right) â€” visibility managed by code-behind for animations -->
        <Border x:Name="SidePanel" Width="550" HorizontalAlignment="Right"
                Background="White" BorderBrush="#E0E0E0" BorderThickness="1,0,0,0"
                Visibility="Collapsed">
            <Border.RenderTransform>
                <TranslateTransform x:Name="SidePanelTransform" X="550"/>
            </Border.RenderTransform>

            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>  <!-- Header -->
                    <RowDefinition Height="*"/>     <!-- Content -->
                </Grid.RowDefinitions>

                <!-- Side Panel Header -->
                <Border Grid.Row="0" Background="#F5F5F5" Padding="14,10"
                        BorderBrush="#E0E0E0" BorderThickness="0,0,0,1">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        <emoji:TextBlock Grid.Column="0" Text="ðŸ“Š Office Panel" FontSize="14"
                                   FontWeight="SemiBold" Foreground="#212121"
                                   VerticalAlignment="Center"/>
                        <Button Grid.Column="1" Style="{StaticResource IconButton}"
                                Command="{Binding ToggleSidePanelCommand}" ToolTip="Close panel">
                            <TextBlock Text="âœ•" FontSize="14" Foreground="#757575"/>
                        </Button>
                    </Grid>
                </Border>

                <!-- Side Panel Scrollable Content -->
                <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto" Padding="12">
                    <StackPanel>

                        <!-- Section 1: Live Commentary -->
                        <Expander IsExpanded="True" Margin="0,0,0,8">
                            <Expander.Header>
                                <emoji:TextBlock Text="ðŸ’­ Live Commentary" FontSize="13"
                                           FontWeight="SemiBold" Foreground="#424242"/>
                            </Expander.Header>
                            <!-- Bug #3 fix: ScrollViewer for scrollable commentary + increased height -->
                            <Border Background="#FAFAFA" CornerRadius="4" Padding="8" MaxHeight="300"
                                    Margin="0,4,0,0">
                                <ScrollViewer VerticalScrollBarVisibility="Auto"
                                              HorizontalScrollBarVisibility="Disabled">
                                    <ItemsControl ItemsSource="{Binding LiveCommentaries}">
                                        <ItemsControl.ItemTemplate>
                                            <DataTemplate>
                                                <StackPanel Orientation="Horizontal" Margin="0,1">
                                                    <!-- Color emoji via Emoji.Wpf -->
                                                    <emoji:TextBlock Text="{Binding Emoji, Mode=OneWay}"
                                                                     FontSize="12" VerticalAlignment="Top"
                                                                     Margin="0,1,4,0"/>
                                                    <!-- Issue #3 fix: TextBlock instead of TextBox for multi-line selection across items -->
                                                    <TextBlock FontSize="11"
                                                               FontFamily="Cascadia Code, Consolas, Courier New"
                                                               Foreground="#616161"
                                                               TextWrapping="Wrap">
                                                        <TextBlock.Text>
                                                            <MultiBinding StringFormat="{}{0}: {1}">
                                                                <Binding Path="AgentName" Mode="OneWay"/>
                                                                <Binding Path="Message" Mode="OneWay"/>
                                                            </MultiBinding>
                                                        </TextBlock.Text>
                                                    </TextBlock>
                                                </StackPanel>
                                            </DataTemplate>
                                        </ItemsControl.ItemTemplate>
                                    </ItemsControl>
                                </ScrollViewer>
                            </Border>
                        </Expander>

                        <!-- Section 2: Configuration -->
                        <Expander IsExpanded="False" Margin="0,0,0,8">
                            <Expander.Header>
                                <StackPanel Orientation="Horizontal">
                                    <emoji:TextBlock Text="âš™ï¸ Configuration" FontSize="13"
                                               FontWeight="SemiBold" Foreground="#424242"/>
                                    <!-- Inline pending-changes badge in the header -->
                                    <Border CornerRadius="8" Padding="6,2" Margin="8,0,0,0"
                                            Background="#FFF3E0" VerticalAlignment="Center"
                                            Visibility="{Binding HasPendingChanges, Converter={StaticResource BoolToVis}}">
                                        <TextBlock FontSize="10" Foreground="#E65100" FontWeight="SemiBold">
                                            <Run Text="{Binding PendingChangesCount, Mode=OneWay}"/>
                                            <Run Text=" unsaved"/>
                                        </TextBlock>
                                    </Border>
                                    <!-- Inline restart-required badge -->
                                    <Border CornerRadius="8" Padding="6,2" Margin="4,0,0,0"
                                            Background="#FBE9E7" VerticalAlignment="Center"
                                            Visibility="{Binding SettingsRequireRestart, Converter={StaticResource BoolToVis}}"
                                            ToolTip="Reset session to take effect">
                                        <TextBlock Text="PENDING" FontSize="10" Foreground="#BF360C"
                                                   FontWeight="Bold"/>
                                    </Border>
                                </StackPanel>
                            </Expander.Header>
                            <StackPanel Margin="0,8,0,0">

                                <!-- â”€â”€ Pending Changes Banner â”€â”€ -->
                                <Border CornerRadius="6" Padding="10,8" Margin="0,0,0,10"
                                        Background="#FFF8E1" BorderBrush="#FFE082" BorderThickness="1"
                                        Visibility="{Binding HasPendingChanges, Converter={StaticResource BoolToVis}}">
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="Auto"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>
                                        <TextBlock Grid.Column="0" FontSize="12" Foreground="#F57F17"
                                                   VerticalAlignment="Center" TextWrapping="Wrap">
                                            <Run Text="âš " FontWeight="Bold"/>
                                            <Run Text=" "/>
                                            <Run Text="{Binding PendingChangesCount, Mode=OneWay}"/>
                                            <Run Text=" setting(s) modified"/>
                                        </TextBlock>
                                        <Button Grid.Column="1" Style="{StaticResource ActionButton}"
                                                Background="#4CAF50" Foreground="White"
                                                Command="{Binding ApplySettingsCommand}"
                                                Margin="6,0,4,0" Padding="10,4">
                                            <TextBlock Text="âœ“ Apply" FontSize="11" FontWeight="SemiBold"/>
                                        </Button>
                                        <Button Grid.Column="2" Style="{StaticResource ActionButton}"
                                                Background="#9E9E9E" Foreground="White"
                                                Command="{Binding DiscardSettingsCommand}"
                                                Padding="10,4">
                                            <TextBlock Text="âœ• Discard" FontSize="11"/>
                                        </Button>
                                    </Grid>
                                </Border>

                                <!-- â”€â”€ Restart Required Banner â”€â”€ -->
                                <Border CornerRadius="6" Padding="10,8" Margin="0,0,0,10"
                                        Background="#FBE9E7" BorderBrush="#FFAB91" BorderThickness="1"
                                        Visibility="{Binding SettingsRequireRestart, Converter={StaticResource BoolToVis}}"
                                        ToolTip="Settings were saved but the running session uses the previous config. Reset or restart the session to pick up changes.">
                                    <StackPanel Orientation="Horizontal">
                                        <TextBlock Text="ðŸ”„" FontSize="13" VerticalAlignment="Center"
                                                   Margin="0,0,6,0"/>
                                        <TextBlock Text="PENDING â€” Reset session to take effect"
                                                   FontSize="12" Foreground="#BF360C"
                                                   FontWeight="SemiBold" VerticalAlignment="Center"/>
                                    </StackPanel>
                                </Border>

                                <!-- â”€â”€ Models Group â”€â”€ -->
                                <TextBox Style="{StaticResource SelectableText}" Text="MODELS" FontSize="10" Foreground="#9E9E9E"
                                         FontWeight="Bold" Margin="0,0,0,6"/>

                                <!-- Manager Model -->
                                <TextBox Style="{StaticResource SelectableText}" Text="Manager Model" FontSize="11" Foreground="#757575"
                                         Margin="0,0,0,3"/>
                                <Grid Margin="0,0,0,8">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    <ComboBox Grid.Column="0"
                                              ItemsSource="{Binding AvailableModels}"
                                              Text="{Binding SelectedManagerModel, UpdateSourceTrigger=PropertyChanged}"
                                              IsEditable="True" FontSize="12" Padding="4,4"
                                              VerticalAlignment="Center"
                                              ToolTip="Select or type a model name for the Manager agent"/>
                                    <Button Grid.Column="1"
                                            Command="{Binding RefreshModelsCommand}"
                                            ToolTip="Refresh available models" Margin="4,0,0,0">
                                        <Button.Style>
                                            <Style TargetType="Button" BasedOn="{StaticResource IconButton}">
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding IsLoadingModels}" Value="True">
                                                        <Setter Property="IsEnabled" Value="False"/>
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </Button.Style>
                                        <TextBlock Text="ðŸ”„" FontSize="13"/>
                                    </Button>
                                </Grid>

                                <!-- Assistant Model -->
                                <TextBox Style="{StaticResource SelectableText}" Text="Assistant Model" FontSize="11" Foreground="#757575"
                                         Margin="0,0,0,3"/>
                                <ComboBox ItemsSource="{Binding AvailableModels}"
                                          Text="{Binding SelectedAssistantModel, UpdateSourceTrigger=PropertyChanged}"
                                          IsEditable="True" FontSize="12" Padding="4,4"
                                          Margin="0,0,0,12"
                                          ToolTip="Select or type a model name for Assistant agents"/>

                                <!-- â”€â”€ Workspace â”€â”€ -->
                                <TextBox Style="{StaticResource SelectableText}" Text="WORKSPACE" FontSize="10" Foreground="#9E9E9E"
                                         FontWeight="Bold" Margin="0,0,0,6"/>

                                <TextBox Style="{StaticResource SelectableText}" Text="Workspace Path" FontSize="11" Foreground="#757575"
                                         Margin="0,0,0,3"/>
                                <Grid Margin="0,0,0,12">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    <TextBox Grid.Column="0"
                                             Text="{Binding WorkspacePath, UpdateSourceTrigger=PropertyChanged}"
                                             FontSize="12" Padding="4,4"
                                             VerticalAlignment="Center"
                                             ToolTip="Repository or workspace directory for assistant work"/>
                                    <Button Grid.Column="1" Style="{StaticResource IconButton}"
                                            Command="{Binding BrowseWorkspaceCommand}"
                                            ToolTip="Browse for workspace folder" Margin="4,0,0,0">
                                        <TextBlock Text="ðŸ“" FontSize="13"/>
                                    </Button>
                                </Grid>

                                <!-- â”€â”€ Timing & Limits Group â”€â”€ -->
                                <TextBox Style="{StaticResource SelectableText}" Text="TIMING &amp; LIMITS" FontSize="10" Foreground="#9E9E9E"
                                         FontWeight="Bold" Margin="0,0,0,6"/>

                                <Grid Margin="0,0,0,8">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                    </Grid.RowDefinitions>

                                    <!-- Row 0: Check Interval -->
                                    <TextBox Style="{StaticResource SelectableText}" Grid.Row="0" Grid.Column="0"
                                             Text="Check Interval (min)" FontSize="11"
                                             Foreground="#757575" Margin="0,0,8,3"
                                             VerticalAlignment="Bottom"/>
                                    <TextBox Style="{StaticResource SelectableText}" Grid.Row="0" Grid.Column="1"
                                             Text="Max Assistants" FontSize="11"
                                             Foreground="#757575" Margin="0,0,0,3"
                                             VerticalAlignment="Bottom"/>

                                    <!-- Row 1: Check Interval + Max Assistants values -->
                                    <TextBox Grid.Row="1" Grid.Column="0"
                                             Text="{Binding CheckIntervalMinutes, UpdateSourceTrigger=PropertyChanged}"
                                             Width="60" FontSize="12" Padding="4,3"
                                             HorizontalContentAlignment="Center"
                                             HorizontalAlignment="Left"
                                             Margin="0,0,8,8"
                                             ToolTip="Minutes between iteration cycles (1â€“60)"/>
                                    <TextBox Grid.Row="1" Grid.Column="1"
                                             Text="{Binding MaxAssistants, UpdateSourceTrigger=PropertyChanged}"
                                             Width="60" FontSize="12" Padding="4,3"
                                             HorizontalContentAlignment="Center"
                                             HorizontalAlignment="Left"
                                             Margin="0,0,0,8"
                                             ToolTip="Maximum concurrent assistant sessions"/>

                                    <!-- Row 2: Assistant Timeout + Manager LLM Timeout labels -->
                                    <TextBox Style="{StaticResource SelectableText}" Grid.Row="2" Grid.Column="0"
                                             Text="Assistant Timeout (s)" FontSize="11"
                                             Foreground="#757575" Margin="0,0,8,3"
                                             VerticalAlignment="Bottom"/>
                                    <TextBox Style="{StaticResource SelectableText}" Grid.Row="2" Grid.Column="1"
                                             Text="Manager LLM Timeout (s)" FontSize="11"
                                             Foreground="#757575" Margin="0,0,0,3"
                                             VerticalAlignment="Bottom"/>

                                    <!-- Row 3: Assistant Timeout + Manager LLM Timeout values -->
                                    <TextBox Grid.Row="3" Grid.Column="0"
                                             Text="{Binding AssistantTimeoutSeconds, UpdateSourceTrigger=PropertyChanged}"
                                             Width="70" FontSize="12" Padding="4,3"
                                             HorizontalContentAlignment="Center"
                                             HorizontalAlignment="Left"
                                             Margin="0,0,8,8"
                                             ToolTip="Timeout per assistant task in seconds (60â€“3600)"/>
                                    <TextBox Grid.Row="3" Grid.Column="1"
                                             Text="{Binding ManagerLlmTimeoutSeconds, UpdateSourceTrigger=PropertyChanged}"
                                             Width="70" FontSize="12" Padding="4,3"
                                             HorizontalContentAlignment="Center"
                                             HorizontalAlignment="Left"
                                             Margin="0,0,0,8"
                                             ToolTip="Timeout for Manager LLM calls in seconds (10â€“300)"/>

                                    <!-- Row 4: Max Retries + Max Queue Depth labels -->
                                    <TextBox Style="{StaticResource SelectableText}" Grid.Row="4" Grid.Column="0"
                                             Text="Max Retries" FontSize="11"
                                             Foreground="#757575" Margin="0,0,8,3"
                                             VerticalAlignment="Bottom"/>
                                    <TextBox Style="{StaticResource SelectableText}" Grid.Row="4" Grid.Column="1"
                                             Text="Max Queue Depth" FontSize="11"
                                             Foreground="#757575" Margin="0,0,0,3"
                                             VerticalAlignment="Bottom"/>

                                    <!-- Row 5: Max Retries + Max Queue Depth values -->
                                    <TextBox Grid.Row="5" Grid.Column="0"
                                             Text="{Binding MaxRetries, UpdateSourceTrigger=PropertyChanged}"
                                             Width="60" FontSize="12" Padding="4,3"
                                             HorizontalContentAlignment="Center"
                                             HorizontalAlignment="Left"
                                             Margin="0,0,8,0"
                                             ToolTip="Maximum retries for a failed assistant task (0â€“10)"/>
                                    <TextBox Grid.Row="5" Grid.Column="1"
                                             Text="{Binding MaxQueueDepth, UpdateSourceTrigger=PropertyChanged}"
                                             Width="60" FontSize="12" Padding="4,3"
                                             HorizontalContentAlignment="Center"
                                             HorizontalAlignment="Left"
                                             ToolTip="Maximum queue depth before tasks are rejected (1â€“100)"/>
                                </Grid>

                                <!-- â”€â”€ Behavior Toggles Group â”€â”€ -->
                                <TextBox Style="{StaticResource SelectableText}" Text="BEHAVIOR" FontSize="10" Foreground="#9E9E9E"
                                         FontWeight="Bold" Margin="0,8,0,6"/>

                                <!-- Require Plan Approval Toggle -->
                                <Border Background="#F5F5F5" CornerRadius="6" Padding="10,8"
                                        Margin="0,0,0,8">
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>
                                        <StackPanel Grid.Column="0">
                                            <TextBox Style="{StaticResource SelectableText}" Text="Require Plan Approval" FontSize="12"
                                                     Foreground="#424242" FontWeight="SemiBold"/>
                                            <TextBox Style="{StaticResource SelectableText}" Text="Pause for user approval before executing tasks"
                                                     FontSize="10" Foreground="#9E9E9E"
                                                     Margin="0,2,8,0"/>
                                        </StackPanel>
                                        <CheckBox Grid.Column="1" VerticalAlignment="Center"
                                                  IsChecked="{Binding RequirePlanApproval}"
                                                  ToolTip="When on, the Manager will present a plan and wait for approval before dispatching tasks."/>
                                    </Grid>
                                </Border>

                                <!-- Streaming Tokens Toggle -->
                                <Border Background="#F5F5F5" CornerRadius="6" Padding="10,8"
                                        Margin="0,0,0,10">
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>
                                        <StackPanel Grid.Column="0">
                                            <TextBox Style="{StaticResource SelectableText}" Text="Stream Reasoning Tokens" FontSize="12"
                                                     Foreground="#424242" FontWeight="SemiBold"/>
                                            <TextBox Style="{StaticResource SelectableText}" Text="Show LLM thinking word-by-word in commentary"
                                                     FontSize="10" Foreground="#9E9E9E"
                                                     Margin="0,2,8,0"/>
                                        </StackPanel>
                                        <CheckBox Grid.Column="1" VerticalAlignment="Center"
                                                  IsChecked="{Binding IsStreamingTokens}"
                                                  ToolTip="When on, reasoning streams live. When off, emitted as complete thoughts."/>
                                    </Grid>
                                </Border>

                                <!-- â”€â”€ Apply / Discard Buttons â”€â”€ -->
                                <StackPanel Orientation="Horizontal" HorizontalAlignment="Right"
                                            Margin="0,4,0,8"
                                            Visibility="{Binding HasPendingChanges, Converter={StaticResource BoolToVis}}">
                                    <Button Style="{StaticResource ActionButton}"
                                            Background="#4CAF50" Foreground="White"
                                            Command="{Binding ApplySettingsCommand}"
                                            Margin="0,0,6,0" Padding="12,6">
                                        <TextBlock Text="âœ“ Apply Changes" FontSize="12" FontWeight="SemiBold"/>
                                    </Button>
                                    <Button Style="{StaticResource ActionButton}"
                                            Background="#9E9E9E" Foreground="White"
                                            Command="{Binding DiscardSettingsCommand}"
                                            Padding="12,6">
                                        <TextBlock Text="âœ• Discard" FontSize="12"/>
                                    </Button>
                                </StackPanel>

                                <!-- â”€â”€ Session Control â”€â”€ -->
                                <TextBox Style="{StaticResource SelectableText}" Text="SESSION CONTROL" FontSize="10" Foreground="#9E9E9E"
                                         FontWeight="Bold" Margin="0,4,0,6"/>

                                <WrapPanel Margin="0,0,0,4">
                                    <Button Style="{StaticResource ActionButton}"
                                            Background="#FF9800" Foreground="White"
                                            Command="{Binding PauseCommand}" Margin="0,0,6,6"
                                            Padding="10,5">
                                        <TextBlock Text="â¸ Pause" FontSize="11"/>
                                    </Button>
                                    <Button Style="{StaticResource ActionButton}"
                                            Background="#4CAF50" Foreground="White"
                                            Command="{Binding ResumeCommand}" Margin="0,0,6,6"
                                            Padding="10,5">
                                        <TextBlock Text="â–¶ Resume" FontSize="11"/>
                                    </Button>
                                    <Button Style="{StaticResource ActionButton}"
                                            Background="#D32F2F" Foreground="White"
                                            Command="{Binding StopCommand}" Margin="0,0,6,6"
                                            Padding="10,5">
                                        <TextBlock Text="â¹ Stop" FontSize="11"/>
                                    </Button>
                                    <Button Style="{StaticResource ActionButton}"
                                            Background="#9E9E9E" Foreground="White"
                                            Command="{Binding ResetCommand}" Margin="0,0,6,6"
                                            Padding="10,5">
                                        <TextBlock Text="ðŸ”„ Reset" FontSize="11"/>
                                    </Button>
                                </WrapPanel>
                            </StackPanel>
                        </Expander>

                        <!-- Section 3: Event Log -->
                        <Expander IsExpanded="False" Margin="0,0,0,8">
                            <Expander.Header>
                                <emoji:TextBlock Text="ðŸ“ Event Log" FontSize="13"
                                           FontWeight="SemiBold" Foreground="#424242"/>
                            </Expander.Header>
                            <Border Background="#FAFAFA" CornerRadius="4" Padding="8" MaxHeight="250"
                                    Margin="0,4,0,0">
                                <ItemsControl ItemsSource="{Binding EventLog}">
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <TextBox Style="{StaticResource SelectableText}"
                                                     Text="{Binding Mode=OneWay}"
                                                     FontFamily="Cascadia Code, Consolas, Courier New"
                                                     FontSize="10" Foreground="#616161"
                                                     Margin="0,1"/>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                            </Border>
                        </Expander>

                        <!-- Section 4: Iteration Stats -->
                        <Expander IsExpanded="True" Margin="0,0,0,8">
                            <Expander.Header>
                                <emoji:TextBlock Text="ðŸ“ˆ Stats" FontSize="13"
                                           FontWeight="SemiBold" Foreground="#424242"/>
                            </Expander.Header>
                            <Grid Margin="0,8,0,0">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                </Grid.RowDefinitions>

                                <StackPanel Grid.Row="0" Grid.Column="0" Margin="0,0,0,8">
                                    <TextBox Style="{StaticResource SelectableText}" Text="Total Iterations" FontSize="10" Foreground="#9E9E9E"/>
                                    <TextBox Style="{StaticResource SelectableText}" Text="{Binding TotalIterations, Mode=OneWay}"
                                             FontSize="18" FontWeight="SemiBold" Foreground="#212121"/>
                                </StackPanel>

                                <StackPanel Grid.Row="0" Grid.Column="1" Margin="0,0,0,8">
                                    <TextBox Style="{StaticResource SelectableText}" Text="Tasks Completed" FontSize="10" Foreground="#9E9E9E"/>
                                    <TextBox Style="{StaticResource SelectableText}" Text="{Binding TotalTasksCompleted, Mode=OneWay}"
                                             FontSize="18" FontWeight="SemiBold" Foreground="#212121"/>
                                </StackPanel>

                                <StackPanel Grid.Row="1" Grid.Column="0">
                                    <TextBox Style="{StaticResource SelectableText}" Text="Success Rate" FontSize="10" Foreground="#9E9E9E"/>
                                    <TextBox Style="{StaticResource SelectableText}" Text="{Binding SuccessRate, Mode=OneWay}"
                                             FontSize="18" FontWeight="SemiBold" Foreground="#4CAF50"/>
                                </StackPanel>

                <StackPanel Grid.Row="1" Grid.Column="1">
                                    <TextBox Style="{StaticResource SelectableText}" Text="Avg Duration" FontSize="10" Foreground="#9E9E9E"/>
                                    <TextBox Style="{StaticResource SelectableText}" Text="{Binding AverageDuration, Mode=OneWay}"
                                             FontSize="18" FontWeight="SemiBold" Foreground="#1976D2"/>
                                </StackPanel>
                            </Grid>
                        </Expander>
                    </StackPanel>
                </ScrollViewer>
            </Grid>
        </Border>
    </Grid>
</UserControl>