<UserControl x:Class="CopilotAgent.App.Views.AgentTeamView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:converters="clr-namespace:CopilotAgent.App.Converters"
             xmlns:mdxaml="clr-namespace:MdXaml;assembly=MdXaml"
             xmlns:emoji="clr-namespace:Emoji.Wpf;assembly=Emoji.Wpf"
             xmlns:sys="clr-namespace:System;assembly=System.Runtime"
             mc:Ignorable="d"
             d:DesignHeight="700" d:DesignWidth="950"
             Background="White">

    <UserControl.Resources>
        <converters:BoolToVisibilityConverter x:Key="BoolToVis"/>
        <converters:InverseBoolToVisibilityConverter x:Key="InverseBoolToVis"/>
        <converters:StringToVisibilityConverter x:Key="StringToVis"/>
        <converters:NonZeroCountToVisibilityConverter x:Key="NonZeroCountToVis"/>
        <converters:StringToBrushConverter x:Key="StringToBrush"/>
        <converters:StringToColorConverter x:Key="StringToColor"/>

        <!-- MdXaml Markdown style overrides for dark-on-light rendering -->
        <Style x:Key="MdXamlStyle" TargetType="mdxaml:MarkdownScrollViewer">
            <Setter Property="MarkdownStyleName" Value="Standard"/>
            <Setter Property="Foreground" Value="#424242"/>
            <Setter Property="FontSize" Value="13"/>
            <Setter Property="VerticalScrollBarVisibility" Value="Auto"/>
            <Setter Property="Background" Value="Transparent"/>
        </Style>

        <!-- Phase badge style -->
        <Style x:Key="PhaseBadge" TargetType="Border">
            <Setter Property="CornerRadius" Value="10"/>
            <Setter Property="Padding" Value="10,4"/>
            <Setter Property="HorizontalAlignment" Value="Left"/>
        </Style>

        <!-- Action button style -->
        <Style x:Key="ActionButton" TargetType="Button">
            <Setter Property="Padding" Value="16,8"/>
            <Setter Property="FontSize" Value="13"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="ActionBorder"
                                Background="{TemplateBinding Background}"
                                CornerRadius="4"
                                Padding="{TemplateBinding Padding}">
                            <ContentPresenter HorizontalAlignment="Center"
                                              VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter TargetName="ActionBorder" Property="Opacity" Value="0.4"/>
                            </Trigger>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="ActionBorder" Property="Opacity" Value="0.85"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
            <Style.Triggers>
                <Trigger Property="IsEnabled" Value="False">
                    <Setter Property="Cursor" Value="Arrow"/>
                </Trigger>
            </Style.Triggers>
        </Style>

        <!-- Small icon button (settings, etc.) -->
        <Style x:Key="IconButton" TargetType="Button">
            <Setter Property="Padding" Value="6,4"/>
            <Setter Property="FontSize" Value="15"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border Background="{TemplateBinding Background}"
                                CornerRadius="4"
                                Padding="{TemplateBinding Padding}">
                            <ContentPresenter HorizontalAlignment="Center"
                                              VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter Property="Background" Value="#E0E0E0"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- Next Step action button style -->
        <Style x:Key="NextStepButton" TargetType="Button">
            <Setter Property="Padding" Value="12,6"/>
            <Setter Property="FontSize" Value="12"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Background" Value="#E3F2FD"/>
            <Setter Property="Foreground" Value="#1565C0"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="BorderBrush" Value="#90CAF9"/>
            <Setter Property="Margin" Value="0,0,8,6"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="Bd" Background="{TemplateBinding Background}"
                                CornerRadius="16"
                                Padding="{TemplateBinding Padding}"
                                BorderBrush="{TemplateBinding BorderBrush}"
                                BorderThickness="{TemplateBinding BorderThickness}">
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="â–¶" FontSize="10" Margin="0,0,6,0"
                                           VerticalAlignment="Center"
                                           Foreground="{TemplateBinding Foreground}"/>
                                <ContentPresenter VerticalAlignment="Center"/>
                            </StackPanel>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="Bd" Property="Background" Value="#BBDEFB"/>
                                <Setter TargetName="Bd" Property="BorderBrush" Value="#42A5F5"/>
                            </Trigger>
                            <Trigger Property="IsPressed" Value="True">
                                <Setter TargetName="Bd" Property="Background" Value="#90CAF9"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- Settings label style -->
        <Style x:Key="SettingsLabel" TargetType="TextBlock">
            <Setter Property="FontSize" Value="12"/>
            <Setter Property="Foreground" Value="#616161"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
            <Setter Property="Margin" Value="0,0,6,0"/>
        </Style>
    </UserControl.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>  <!-- Header -->
            <RowDefinition Height="Auto"/>  <!-- Settings panel (collapsible) -->
            <RowDefinition Height="Auto"/>  <!-- Session + Execution indicators -->
            <RowDefinition Height="Auto"/>  <!-- Worker status pills -->
            <RowDefinition Height="*"/>     <!-- Main scrollable content -->
            <RowDefinition Height="Auto"/>  <!-- Bottom input bar -->
        </Grid.RowDefinitions>

        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <!-- Row 0: Header Bar                                       -->
        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <Border Grid.Row="0" Background="#F5F5F5" Padding="16,10"
                BorderBrush="#E0E0E0" BorderThickness="0,0,0,1">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>  <!-- Title -->
                    <ColumnDefinition Width="Auto"/>  <!-- Phase badge -->
                    <ColumnDefinition Width="*"/>     <!-- Spacer -->
                    <ColumnDefinition Width="Auto"/>  <!-- Pending approvals -->
                    <ColumnDefinition Width="Auto"/>  <!-- Session indicator -->
                    <ColumnDefinition Width="Auto"/>  <!-- Settings button -->
                    <ColumnDefinition Width="Auto"/>  <!-- Reset button -->
                </Grid.ColumnDefinitions>

                <!-- Title -->
                <emoji:TextBlock Grid.Column="0" Text="ðŸ¤– Agent Team"
                           FontSize="16" FontWeight="SemiBold"
                           VerticalAlignment="Center" Foreground="#212121"/>

                <!-- Phase Badge (color-coded + pulsing) -->
                <Border Grid.Column="1" Style="{StaticResource PhaseBadge}"
                        Margin="12,0,0,0" VerticalAlignment="Center"
                        Opacity="{Binding CurrentPhaseBadgeOpacity}"
                        Background="{Binding CurrentPhaseColor, Converter={StaticResource StringToBrush}}">
                    <TextBlock Text="{Binding CurrentPhaseDisplay}"
                               FontSize="12" FontWeight="SemiBold" Foreground="White"/>
                </Border>

                <!-- Team Status Display (center) -->
                <StackPanel Grid.Column="2" Orientation="Horizontal"
                            HorizontalAlignment="Center" VerticalAlignment="Center">
                    <!-- Rotating icon wrapper â€” Border handles the rotation Storyboard,
                         emoji:TextBlock inside renders color emoji icons -->
                    <Border x:Name="TeamStatusIconWrapper"
                            VerticalAlignment="Center" Margin="0,0,6,0"
                            RenderTransformOrigin="0.5,0.5">
                        <Border.RenderTransform>
                            <RotateTransform Angle="0"/>
                        </Border.RenderTransform>
                        <Border.Style>
                            <Style TargetType="Border">
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding TeamStatusIconRotating}" Value="True">
                                        <DataTrigger.EnterActions>
                                            <BeginStoryboard x:Name="SpinStoryboard">
                                                <Storyboard>
                                                    <DoubleAnimation
                                                        Storyboard.TargetProperty="(UIElement.RenderTransform).(RotateTransform.Angle)"
                                                        From="0" To="360"
                                                        Duration="0:0:2"
                                                        RepeatBehavior="Forever"/>
                                                </Storyboard>
                                            </BeginStoryboard>
                                        </DataTrigger.EnterActions>
                                        <DataTrigger.ExitActions>
                                            <StopStoryboard BeginStoryboardName="SpinStoryboard"/>
                                        </DataTrigger.ExitActions>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </Border.Style>
                        <emoji:TextBlock Text="{Binding TeamStatusIcon}" FontSize="16"/>
                    </Border>
                    <!-- Status text -->
                    <TextBlock Text="{Binding TeamStatusText}" FontSize="12"
                               FontWeight="SemiBold" VerticalAlignment="Center"
                               Foreground="{Binding TeamStatusColor, Converter={StaticResource StringToBrush}}"/>
                </StackPanel>

                <!-- Pending Approvals -->
                <Border Grid.Column="3" CornerRadius="10" Padding="8,4"
                        Background="#FFF3E0" Margin="0,0,4,0" VerticalAlignment="Center"
                        Visibility="{Binding PendingApprovals, Converter={StaticResource NonZeroCountToVis}}">
                    <StackPanel Orientation="Horizontal">
                        <emoji:TextBlock Text="âš  " FontSize="11" VerticalAlignment="Center"/>
                        <TextBlock FontSize="11" Foreground="#E65100" VerticalAlignment="Center">
                            <Run Text="{Binding PendingApprovals, Mode=OneWay}"/>
                            <Run Text=" pending"/>
                        </TextBlock>
                    </StackPanel>
                </Border>

                <!-- Session Health Indicator (LIVE/IDLE/ERROR with blinking dot) â€” right side before settings -->
                <Border Grid.Column="4" CornerRadius="10" Padding="8,4"
                        Margin="4,0" VerticalAlignment="Center"
                        Background="#FAFAFA" BorderBrush="#E0E0E0" BorderThickness="1"
                        Opacity="{Binding SessionIndicatorOpacity}">
                    <StackPanel Orientation="Horizontal">
                        <Ellipse Width="8" Height="8" Margin="0,0,5,0"
                                 VerticalAlignment="Center"
                                 Fill="{Binding SessionIndicatorColor, Converter={StaticResource StringToBrush}}"/>
                        <TextBlock Text="{Binding SessionIndicatorText}"
                                   FontSize="10" FontWeight="Bold" VerticalAlignment="Center"
                                   Foreground="{Binding SessionIndicatorColor, Converter={StaticResource StringToBrush}}"/>
                    </StackPanel>
                </Border>

                <!-- Reset button -->
                <Button Grid.Column="5"
                        Style="{StaticResource ActionButton}"
                        Background="#EEEEEE" Foreground="#424242"
                        Command="{Binding ResetOrchestratorCommand}"
                        ToolTip="Reset orchestrator context">
                    <emoji:TextBlock Text="ðŸ”„ Reset"/>
                </Button>

                <!-- Settings toggle button (extreme right) -->
                <Button Grid.Column="6" ToolTip="Multi-Agent Settings"
                        Style="{StaticResource IconButton}"
                        Command="{Binding ToggleSettingsCommand}"
                        Margin="4,0">
                    <emoji:TextBlock Text="âš™" FontSize="15"/>
                </Button>
            </Grid>
        </Border>

        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <!-- Row 1: Settings Panel (Toggle-able)                     -->
        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <Border Grid.Row="1" Background="#F9F9F9" Padding="16,12"
                BorderBrush="#E0E0E0" BorderThickness="0,0,0,1"
                Visibility="{Binding ShowSettings, Converter={StaticResource BoolToVis}}">
            <StackPanel>
                <Grid Margin="0,0,0,10">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>
                    <emoji:TextBlock Grid.Column="0" Text="âš™ Multi-Agent Settings" FontSize="14"
                               FontWeight="SemiBold" Foreground="#424242" VerticalAlignment="Center"/>
                    <Button Grid.Column="1"
                            Style="{StaticResource ActionButton}"
                            Background="#E0E0E0" Foreground="#616161"
                            Padding="10,5" FontSize="11"
                            Command="{Binding RestoreDefaultSettingsCommand}"
                            ToolTip="Reset all settings to their default values">
                        <emoji:TextBlock Text="â†© Restore Defaults"/>
                    </Button>
                </Grid>

                <!-- Row 1: Parallelism + Strategy -->
                <WrapPanel Margin="0,0,0,8">
                    <StackPanel Orientation="Horizontal" Margin="0,0,20,4">
                        <TextBlock Text="Parallel Workers:" Style="{StaticResource SettingsLabel}"/>
                        <ComboBox ItemsSource="{Binding ParallelWorkerOptions}"
                                  SelectedItem="{Binding SettingsMaxParallelWorkers}"
                                  Width="60" FontSize="12" VerticalAlignment="Center"/>
                    </StackPanel>

                    <StackPanel Orientation="Horizontal" Margin="0,0,20,4">
                        <TextBlock Text="Workspace Strategy:" Style="{StaticResource SettingsLabel}"/>
                        <ComboBox ItemsSource="{Binding WorkspaceStrategies}"
                                  SelectedItem="{Binding SettingsWorkspaceStrategy}"
                                  Width="120" FontSize="12" VerticalAlignment="Center"/>
                    </StackPanel>

                    <StackPanel Orientation="Horizontal" Margin="0,0,20,4">
                        <TextBlock Text="Worker Timeout (min):" Style="{StaticResource SettingsLabel}"/>
                        <TextBox Text="{Binding SettingsWorkerTimeoutMinutes, UpdateSourceTrigger=PropertyChanged}"
                                 Width="50" FontSize="12" Padding="4,3"
                                 VerticalAlignment="Center" HorizontalContentAlignment="Center"/>
                    </StackPanel>
                </WrapPanel>

                <!-- Row 2: Retry + Auto-approve -->
                <WrapPanel Margin="0,0,0,0">
                    <StackPanel Orientation="Horizontal" Margin="0,0,20,4">
                        <TextBlock Text="Max Retries:" Style="{StaticResource SettingsLabel}"/>
                        <TextBox Text="{Binding SettingsMaxRetries, UpdateSourceTrigger=PropertyChanged}"
                                 Width="40" FontSize="12" Padding="4,3"
                                 VerticalAlignment="Center" HorizontalContentAlignment="Center"/>
                    </StackPanel>

                    <StackPanel Orientation="Horizontal" Margin="0,0,20,4">
                        <TextBlock Text="Retry Delay (sec):" Style="{StaticResource SettingsLabel}"/>
                        <TextBox Text="{Binding SettingsRetryDelaySeconds, UpdateSourceTrigger=PropertyChanged}"
                                 Width="50" FontSize="12" Padding="4,3"
                                 VerticalAlignment="Center" HorizontalContentAlignment="Center"/>
                    </StackPanel>

                    <StackPanel Orientation="Horizontal" Margin="0,0,0,4">
                        <CheckBox IsChecked="{Binding SettingsAutoApproveReadOnly}"
                                  VerticalAlignment="Center" Margin="0,0,6,0"/>
                        <TextBlock Text="Auto-approve read-only tools"
                                   Style="{StaticResource SettingsLabel}"/>
                    </StackPanel>
                </WrapPanel>
            </StackPanel>
        </Border>

        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <!-- Row 2: Execution Status Indicator (pulsing strip)       -->
        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <Border Grid.Row="2" Background="#E3F2FD" Padding="12,8" Margin="16,8,16,0"
                CornerRadius="6"
                Opacity="{Binding ExecutionPulseOpacity}"
                Visibility="{Binding IsExecutionIndicatorVisible, Converter={StaticResource BoolToVis}}">
            <StackPanel Orientation="Horizontal">
                <Ellipse Width="10" Height="10" Fill="#1976D2" Margin="0,0,8,0"
                         VerticalAlignment="Center"/>
                <TextBlock Text="{Binding ExecutionStatusText}" FontSize="13"
                           FontWeight="SemiBold" Foreground="#1565C0"
                           VerticalAlignment="Center"/>
            </StackPanel>
        </Border>

        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <!-- Row 3: Worker Status Pills (full lifecycle)             -->
        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <ItemsControl Grid.Row="3" ItemsSource="{Binding Workers}"
                      Margin="16,6,16,0"
                      Visibility="{Binding Workers.Count, Converter={StaticResource NonZeroCountToVis}}">
            <ItemsControl.ItemsPanel>
                <ItemsPanelTemplate>
                    <WrapPanel Orientation="Horizontal"/>
                </ItemsPanelTemplate>
            </ItemsControl.ItemsPanel>
            <ItemsControl.ItemTemplate>
                <DataTemplate>
                    <Border CornerRadius="12" Padding="10,5" Margin="0,0,6,5"
                            BorderThickness="1" ToolTip="{Binding Activity}"
                            BorderBrush="{Binding StatusColor, Converter={StaticResource StringToBrush}}"
                            Background="#FAFAFA">
                        <StackPanel Orientation="Horizontal">
                            <!-- Status dot -->
                            <Ellipse Width="8" Height="8" Margin="0,0,6,0"
                                     VerticalAlignment="Center"
                                     Fill="{Binding StatusColor, Converter={StaticResource StringToBrush}}"/>
                            <!-- Worker title -->
                            <TextBlock Text="{Binding Title}" FontSize="11" FontWeight="SemiBold"
                                       VerticalAlignment="Center" Margin="0,0,4,0"
                                       Foreground="{Binding StatusColor, Converter={StaticResource StringToBrush}}"/>
                            <!-- Status emoji -->
                            <TextBlock Text="{Binding StatusDisplay}" FontSize="10"
                                       Foreground="#757575" VerticalAlignment="Center"/>
                        </StackPanel>
                    </Border>
                </DataTemplate>
            </ItemsControl.ItemTemplate>
        </ItemsControl>

        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <!-- Row 4: Main Scrollable Content                          -->
        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <ScrollViewer Grid.Row="4" VerticalScrollBarVisibility="Auto" Padding="16">
            <StackPanel>

                <!-- Error message -->
                <Border Background="#FFEBEE" CornerRadius="4" Padding="12,8" Margin="0,0,0,12"
                        Visibility="{Binding ErrorMessage, Converter={StaticResource StringToVis}}">
                    <TextBlock Text="{Binding ErrorMessage}" Foreground="#C62828"
                               TextWrapping="Wrap" FontSize="13"/>
                </Border>

                <!-- Orchestrator Message (Markdown rendered) -->
                <Border Background="#F3E5F5" CornerRadius="6" Padding="14,10" Margin="0,0,0,12"
                        Visibility="{Binding OrchestratorMessage, Converter={StaticResource StringToVis}}">
                    <StackPanel>
                        <mdxaml:MarkdownScrollViewer Markdown="{Binding OrchestratorMessage}"
                                                      Style="{StaticResource MdXamlStyle}"
                                                      Foreground="#4A148C"
                                                      VerticalScrollBarVisibility="Disabled"/>
                        <!-- Copy response button at bottom-right -->
                        <Grid Margin="0,6,0,0" HorizontalAlignment="Stretch">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <Button Grid.Column="1"
                                    ToolTip="Copy response text to clipboard"
                                    Command="{Binding CopyOrchestratorMessageCommand}"
                                    Cursor="Hand" Padding="6"
                                    Background="Transparent" BorderThickness="0">
                                <Button.Style>
                                    <Style TargetType="Button">
                                        <Setter Property="Opacity" Value="0.5"/>
                                        <Style.Triggers>
                                            <Trigger Property="IsMouseOver" Value="True">
                                                <Setter Property="Opacity" Value="1.0"/>
                                            </Trigger>
                                        </Style.Triggers>
                                    </Style>
                                </Button.Style>
                                <Grid Width="16" Height="16">
                                    <!-- Copy icon: two overlapping squares -->
                                    <Canvas>
                                        <Rectangle Canvas.Left="3" Canvas.Top="0" Width="13" Height="13"
                                                   Stroke="#7B1FA2" StrokeThickness="1.5" Fill="Transparent" RadiusX="1.5" RadiusY="1.5"/>
                                        <Rectangle Canvas.Left="0" Canvas.Top="3" Width="13" Height="13"
                                                   Stroke="#7B1FA2" StrokeThickness="1.5" Fill="#F3E5F5" RadiusX="1.5" RadiusY="1.5"/>
                                    </Canvas>
                                </Grid>
                            </Button>
                        </Grid>
                    </StackPanel>
                </Border>

                <!-- Clarification Panel -->
                <Border Background="#FFF8E1" CornerRadius="6" Padding="14" Margin="0,0,0,12"
                        Visibility="{Binding ShowClarification, Converter={StaticResource BoolToVis}}">
                    <StackPanel>
                        <emoji:TextBlock Text="ðŸ¤” Clarification Needed" FontSize="14"
                                   FontWeight="SemiBold" Foreground="#F57F17" Margin="0,0,0,8"/>

                        <ItemsControl ItemsSource="{Binding ClarifyingQuestions}" Margin="0,0,0,10">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <TextBlock Text="{Binding}" TextWrapping="Wrap"
                                               FontSize="13" Foreground="#424242" Margin="0,2"/>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>

                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <TextBox Grid.Column="0"
                                     Text="{Binding ClarificationResponse, UpdateSourceTrigger=PropertyChanged}"
                                     Padding="8,6" FontSize="13" VerticalAlignment="Center"
                                     BorderBrush="#BDBDBD" BorderThickness="1"/>
                            <Button Grid.Column="1" Content="Send" Margin="8,0,0,0"
                                    Style="{StaticResource ActionButton}"
                                    Background="#FF8F00" Foreground="White"
                                    Command="{Binding RespondToClarificationCommand}"/>
                        </Grid>
                    </StackPanel>
                </Border>

                <!-- Plan Review Panel -->
                <Border Background="#E8EAF6" CornerRadius="6" Padding="14" Margin="0,0,0,12"
                        Visibility="{Binding ShowPlanReview, Converter={StaticResource BoolToVis}}">
                    <StackPanel>
                        <emoji:TextBlock Text="ðŸ“‹ Plan Review" FontSize="14"
                                   FontWeight="SemiBold" Foreground="#283593" Margin="0,0,0,8"/>

                        <TextBlock Text="{Binding CurrentPlan.PlanSummary}" TextWrapping="Wrap"
                                   FontSize="13" Foreground="#424242" Margin="0,0,0,10"/>

                        <!-- Chunk list -->
                        <ItemsControl ItemsSource="{Binding CurrentPlan.Chunks}" Margin="0,0,0,12">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Border Background="White" CornerRadius="4" Padding="10,6"
                                            Margin="0,0,0,4" BorderBrush="#C5CAE9" BorderThickness="1">
                                        <Grid>
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="24"/>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="Auto"/>
                                            </Grid.ColumnDefinitions>
                                            <TextBlock Grid.Column="0" FontSize="11" Foreground="#9E9E9E"
                                                       VerticalAlignment="Center">
                                                <Run Text="#"/><Run Text="{Binding SequenceIndex, Mode=OneWay}"/>
                                            </TextBlock>
                                            <StackPanel Grid.Column="1">
                                                <TextBlock Text="{Binding Title}" FontWeight="SemiBold"
                                                           FontSize="12" Foreground="#212121"/>
                                                <TextBlock Text="{Binding Prompt}" FontSize="11"
                                                           Foreground="#757575" TextTrimming="CharacterEllipsis"
                                                           MaxHeight="36" TextWrapping="Wrap"/>
                                            </StackPanel>
                                            <Border Grid.Column="2" CornerRadius="8" Padding="6,2"
                                                    Background="#E3F2FD" VerticalAlignment="Center"
                                                    Margin="8,0,0,0">
                                                <TextBlock Text="{Binding AssignedRole}" FontSize="10"
                                                           Foreground="#1565C0"/>
                                            </Border>
                                        </Grid>
                                    </Border>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>

                        <!-- Feedback input -->
                        <TextBox Text="{Binding PlanFeedback, UpdateSourceTrigger=PropertyChanged}"
                                 Padding="8,6" FontSize="13" Margin="0,0,0,8"
                                 BorderBrush="#BDBDBD" BorderThickness="1"
                                 ToolTip="Optional feedback for plan changes"/>

                        <!-- Approval buttons -->
                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                            <Button Margin="0,0,8,0"
                                    Style="{StaticResource ActionButton}"
                                    Background="#4CAF50" Foreground="White"
                                    Command="{Binding ApprovePlanCommand}">
                                <emoji:TextBlock Text="âœ… Approve"/>
                            </Button>
                            <Button Margin="0,0,8,0"
                                    Style="{StaticResource ActionButton}"
                                    Background="#FF9800" Foreground="White"
                                    Command="{Binding RequestPlanChangesCommand}">
                                <emoji:TextBlock Text="âœï¸ Request Changes"/>
                            </Button>
                            <Button Style="{StaticResource ActionButton}"
                                    Background="#F44336" Foreground="White"
                                    Command="{Binding RejectPlanCommand}">
                                <emoji:TextBlock Text="âŒ Reject"/>
                            </Button>
                        </StackPanel>
                    </StackPanel>
                </Border>

                <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
                <!-- Completion Report (Collapsible Expander)        -->
                <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
                <Expander IsExpanded="False" Margin="0,0,0,12"
                          FontSize="13" Foreground="#2E7D32"
                          Visibility="{Binding ShowReport, Converter={StaticResource BoolToVis}}">
                    <Expander.Header>
                        <StackPanel Orientation="Horizontal">
                            <emoji:TextBlock Text="ðŸ“Š Completion Report" FontSize="14"
                                       FontWeight="SemiBold" Foreground="#2E7D32"
                                       VerticalAlignment="Center"/>
                            <!-- Inline stats summary visible even when collapsed -->
                            <Border CornerRadius="8" Padding="8,2" Margin="10,0,0,0"
                                    Background="#C8E6C9" VerticalAlignment="Center">
                                <TextBlock FontSize="11" FontWeight="SemiBold" Foreground="#1B5E20">
                                    <Run Text="âœ… "/>
                                    <Run Text="{Binding LastReport.Stats.SucceededChunks, Mode=OneWay}"/>
                                    <Run Text="/"/>
                                    <Run Text="{Binding LastReport.Stats.TotalChunks, Mode=OneWay}"/>
                                    <Run Text=" chunks  â± "/>
                                    <Run Text="{Binding LastReport.Stats.TotalDuration.TotalSeconds, Mode=OneWay, StringFormat={}{0:F1}s}"/>
                                </TextBlock>
                            </Border>
                            <!-- Dismiss button -->
                            <Button Content="âœ•" Margin="6,0,0,0"
                                    Style="{StaticResource IconButton}"
                                    FontSize="12" Foreground="#757575"
                                    Command="{Binding DismissReportCommand}"
                                    VerticalAlignment="Center"/>
                        </StackPanel>
                    </Expander.Header>

                    <Border Background="#E8F5E9" CornerRadius="0,0,6,6" Padding="14,10">
                        <StackPanel>
                            <!-- Summary text (Markdown rendered) -->
                            <mdxaml:MarkdownScrollViewer Markdown="{Binding LastReport.ConversationalSummary}"
                                                          Style="{StaticResource MdXamlStyle}"
                                                          Foreground="#424242"
                                                          VerticalScrollBarVisibility="Disabled"
                                                          Margin="0,0,0,10"/>

                            <!-- Per-worker result list -->
                            <ItemsControl ItemsSource="{Binding LastReport.WorkerResults}" Margin="0,4,0,0">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Border Background="White" CornerRadius="4" Padding="10,6"
                                                Margin="0,0,0,4" BorderBrush="#A5D6A7" BorderThickness="1">
                                            <StackPanel>
                                                <StackPanel Orientation="Horizontal">
                                                    <TextBlock FontSize="12" FontWeight="SemiBold" Foreground="#212121">
                                                        <Run Text="{Binding ChunkId, Mode=OneWay}"/>
                                                    </TextBlock>
                                                    <TextBlock FontSize="11" Margin="8,0,0,0"
                                                               Foreground="#616161" VerticalAlignment="Center">
                                                        <Run Text="{Binding Duration.TotalSeconds, Mode=OneWay, StringFormat={}{0:F1}s}"/>
                                                    </TextBlock>
                                                </StackPanel>
                                                <TextBlock Text="{Binding Response}" FontSize="11"
                                                           Foreground="#757575" TextWrapping="Wrap"
                                                           MaxHeight="48" TextTrimming="CharacterEllipsis"
                                                           Margin="0,2,0,0"/>
                                            </StackPanel>
                                        </Border>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>

                            <!-- Copy button at bottom-right (ChatView pattern) -->
                            <Grid Margin="0,8,0,0" HorizontalAlignment="Stretch">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>
                                <Button Grid.Column="1"
                                        ToolTip="Copy report text to clipboard"
                                        Command="{Binding CopyReportTextCommand}"
                                        Cursor="Hand" Padding="6"
                                        Background="Transparent" BorderThickness="0">
                                    <Button.Style>
                                        <Style TargetType="Button">
                                            <Setter Property="Opacity" Value="0.5"/>
                                            <Style.Triggers>
                                                <Trigger Property="IsMouseOver" Value="True">
                                                    <Setter Property="Opacity" Value="1.0"/>
                                                </Trigger>
                                            </Style.Triggers>
                                        </Style>
                                    </Button.Style>
                                    <Grid Width="16" Height="16">
                                        <!-- Copy icon: two overlapping squares -->
                                        <Canvas>
                                            <Rectangle Canvas.Left="3" Canvas.Top="0" Width="13" Height="13"
                                                       Stroke="#555" StrokeThickness="1.5" Fill="Transparent" RadiusX="1.5" RadiusY="1.5"/>
                                            <Rectangle Canvas.Left="0" Canvas.Top="3" Width="13" Height="13"
                                                       Stroke="#555" StrokeThickness="1.5" Fill="#E8F5E9" RadiusX="1.5" RadiusY="1.5"/>
                                        </Canvas>
                                    </Grid>
                                </Button>
                            </Grid>
                        </StackPanel>
                    </Border>
                </Expander>

                <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
                <!-- Next Steps Action Buttons                       -->
                <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
                <Border Background="#E8F5E9" CornerRadius="6" Padding="14,10" Margin="0,0,0,12"
                        Visibility="{Binding HasNextSteps, Converter={StaticResource BoolToVis}}">
                    <StackPanel>
                        <emoji:TextBlock Text="ðŸš€ Recommended Next Steps" FontSize="13"
                                   FontWeight="SemiBold" Foreground="#2E7D32" Margin="0,0,0,8"/>
                        <TextBlock Text="Click a step to populate it as your next task:"
                                   FontSize="11" Foreground="#757575" Margin="0,0,0,8"/>
                        <ItemsControl ItemsSource="{Binding NextStepActions}">
                            <ItemsControl.ItemsPanel>
                                <ItemsPanelTemplate>
                                    <WrapPanel Orientation="Horizontal"/>
                                </ItemsPanelTemplate>
                            </ItemsControl.ItemsPanel>
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Button Content="{Binding}"
                                            Style="{StaticResource NextStepButton}"
                                            Command="{Binding DataContext.SelectNextStepCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                            CommandParameter="{Binding}"/>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </StackPanel>
                </Border>

                <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
                <!-- Event Log (Collapsible Expander, data-bound)    -->
                <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
                <Expander Header="ðŸ“ Event Log"
                          IsExpanded="{Binding IsEventLogExpanded, Mode=TwoWay}"
                          Margin="0,0,0,12"
                          FontSize="13" Foreground="#424242">
                    <Border Background="#FAFAFA" CornerRadius="4" Padding="8" MaxHeight="250">
                        <ListBox ItemsSource="{Binding EventLog}"
                                 BorderThickness="0" Background="Transparent"
                                 FontFamily="Cascadia Code, Consolas, Courier New"
                                 FontSize="11" Foreground="#616161"
                                 ScrollViewer.VerticalScrollBarVisibility="Auto"
                                 ScrollViewer.CanContentScroll="True"/>
                    </Border>
                </Expander>
            </StackPanel>
        </ScrollViewer>

        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <!-- Row 5: Bottom Input Bar                                 -->
        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <Border Grid.Row="5" Background="#F5F5F5" Padding="16,10"
                BorderBrush="#E0E0E0" BorderThickness="0,1,0,0">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <!-- Task prompt (when not orchestrating) -->
                <TextBox Grid.Column="0"
                         Text="{Binding TaskPrompt, UpdateSourceTrigger=PropertyChanged}"
                         Padding="10,8" FontSize="13"
                         BorderBrush="#BDBDBD" BorderThickness="1"
                         Visibility="{Binding IsOrchestrating, Converter={StaticResource InverseBoolToVis}}"
                         ToolTip="Describe the task for the agent team"
                         AcceptsReturn="False"
                         KeyDown="TaskInput_KeyDown"/>

                <!-- Injection input (when orchestrating) -->
                <TextBox Grid.Column="0"
                         Text="{Binding InjectionText, UpdateSourceTrigger=PropertyChanged}"
                         Padding="10,8" FontSize="13"
                         BorderBrush="#BDBDBD" BorderThickness="1"
                         Visibility="{Binding IsOrchestrating, Converter={StaticResource BoolToVis}}"
                         ToolTip="Inject instruction into running orchestration"
                         AcceptsReturn="False"
                         KeyDown="InjectionInput_KeyDown"/>

                <!-- Submit button (when not orchestrating) -->
                <Button Grid.Column="1" Margin="8,0,0,0"
                        Style="{StaticResource ActionButton}"
                        Background="#1976D2" Foreground="White"
                        Command="{Binding SubmitTaskCommand}"
                        Visibility="{Binding IsOrchestrating, Converter={StaticResource InverseBoolToVis}}">
                    <emoji:TextBlock Text="ðŸš€ Submit"/>
                </Button>

                <!-- Inject button (when orchestrating) -->
                <Button Grid.Column="1" Margin="8,0,0,0"
                        Style="{StaticResource ActionButton}"
                        Background="#7B1FA2" Foreground="White"
                        Command="{Binding InjectInstructionCommand}"
                        Visibility="{Binding IsOrchestrating, Converter={StaticResource BoolToVis}}">
                    <emoji:TextBlock Text="ðŸ’‰ Inject"/>
                </Button>

                <!-- Cancel button (when orchestrating) -->
                <Button Grid.Column="2" Margin="8,0,0,0"
                        Style="{StaticResource ActionButton}"
                        Background="#D32F2F" Foreground="White"
                        Command="{Binding CancelOrchestrationCommand}"
                        Visibility="{Binding IsOrchestrating, Converter={StaticResource BoolToVis}}">
                    <emoji:TextBlock Text="â¹ Cancel"/>
                </Button>
            </Grid>
        </Border>
    </Grid>
</UserControl>